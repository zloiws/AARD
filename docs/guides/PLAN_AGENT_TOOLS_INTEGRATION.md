# Интеграция агентов и инструментов с выполнением планов

## Обзор

Система выполнения планов теперь поддерживает использование агентов и инструментов для выполнения шагов плана. Это позволяет создавать более сложные и специализированные планы, где каждый шаг может быть выполнен конкретным агентом с использованием определенных инструментов.

## Архитектура

### Компоненты

1. **ExecutionService** (`app/services/execution_service.py`)
   - Обновлен `StepExecutor` для поддержки агентов и инструментов
   - Методы `_execute_with_agent()` и `_execute_with_tool()`
   - Автоматический fallback на LLM при ошибках

2. **Plan Model** (`app/models/plan.py`)
   - Шаги плана могут содержать поля `agent` и `tool`
   - Поддержка `use_tools` для автоматического использования инструментов

3. **AgentService** и **ToolService**
   - Используются для получения и валидации агентов и инструментов

## Формат шага плана

Шаги плана теперь могут содержать следующие поля:

```json
{
  "step_id": "step_1",
  "description": "Описание шага",
  "type": "action",
  "agent": "agent_id или null",  // ID агента для выполнения
  "tool": "tool_id или null",     // ID инструмента для использования
  "use_tools": true,              // Автоматически использовать доступные инструменты
  "inputs": {                      // Входные данные для шага
    "param1": "value1"
  },
  "tool_params": {                // Дополнительные параметры для инструмента
    "extra_param": "value"
  },
  "timeout": 300,
  "approval_required": false
}
```

## Логика выполнения

### Приоритет выполнения

1. **Если указан `agent` и `tool`:**
   - Используется агент с указанным инструментом
   - Агент получает доступ к инструменту через `use_tool()`

2. **Если указан только `agent`:**
   - Используется агент для выполнения шага
   - Если `use_tools=true`, агент видит доступные инструменты и может их использовать

3. **Если указан только `tool` (без агента):**
   - Инструмент выполняется напрямую
   - Параметры берутся из `inputs` и `tool_params`

4. **Если ничего не указано:**
   - Используется стандартное выполнение через LLM (как раньше)

### Fallback механизм

При ошибке выполнения с агентом/инструментом система автоматически переключается на LLM:

```python
try:
    return await self._execute_with_agent(...)
except Exception as e:
    logger.warning("Failed with agent, falling back to LLM")
    # Fall back to LLM execution
```

## Примеры использования

### Пример 1: Шаг с агентом и инструментом

```json
{
  "step_id": "find_files",
  "description": "Найти все Python файлы в директории",
  "type": "action",
  "agent": "file_operations_agent_id",
  "tool": "file_finder_tool_id",
  "inputs": {
    "directory": "/path/to/code",
    "extension": "py"
  }
}
```

**Выполнение:**
1. Система получает агента `file_operations_agent_id`
2. Проверяет, что агент активен
3. Создает экземпляр `SimpleAgent`
4. Вызывает `agent.execute()` с `tool_name="file_finder"`
5. Агент использует инструмент для поиска файлов
6. Результат возвращается в шаг плана

### Пример 2: Шаг только с агентом

```json
{
  "step_id": "analyze_code",
  "description": "Проанализировать код на ошибки",
  "type": "action",
  "agent": "code_analysis_agent_id",
  "use_tools": true,
  "inputs": {
    "code": "def func(): pass"
  }
}
```

**Выполнение:**
1. Агент получает задачу
2. Видит доступные инструменты (если `use_tools=true`)
3. Может автоматически выбрать подходящий инструмент
4. Или использовать LLM для анализа

### Пример 3: Шаг только с инструментом

```json
{
  "step_id": "calculate",
  "description": "Выполнить вычисления",
  "type": "action",
  "tool": "calculator_tool_id",
  "inputs": {
    "operation": "add",
    "a": 5,
    "b": 3
  }
}
```

**Выполнение:**
1. Инструмент выполняется напрямую
2. Параметры передаются из `inputs`
3. Результат возвращается в шаг

## Интеграция с контекстом

Результаты предыдущих шагов автоматически передаются в контекст:

```python
# Контекст из предыдущих шагов
context = {
    "step_1_output": "результат шага 1",
    "step_2_output": "результат шага 2"
}

# Передается в агента/инструмент
agent_result = await agent.execute(
    task_description=description,
    context=context,  # Контекст доступен
    **step_inputs
)
```

## Обработка ошибок

### Ошибки агента

- Если агент не найден → fallback на LLM
- Если агент не активен → ошибка с понятным сообщением
- Если выполнение агента провалилось → fallback на LLM

### Ошибки инструмента

- Если инструмент не найден → fallback на LLM
- Если инструмент не активен → ошибка
- Если выполнение инструмента провалилось → fallback на LLM

### Логирование

Все ошибки логируются с контекстом:
- ID шага
- ID агента/инструмента
- Тип ошибки
- Fallback статус

## Метрики

Выполнение шагов с агентами и инструментами учитывается в метриках:

- `plan_steps_total` - общее количество шагов
- `plan_step_duration_seconds` - длительность шагов
- Метрики агентов (через `AgentService.record_task_execution`)
- Метрики инструментов (через `ToolService.record_execution`)

## Пример полного плана

```json
{
  "goal": "Создать и протестировать функцию",
  "steps": [
    {
      "step_id": "generate_code",
      "description": "Сгенерировать код функции",
      "type": "action",
      "agent": "code_generator_agent_id",
      "inputs": {
        "function_name": "calculate_sum",
        "description": "Функция для сложения двух чисел"
      }
    },
    {
      "step_id": "test_code",
      "description": "Протестировать сгенерированный код",
      "type": "action",
      "agent": "code_tester_agent_id",
      "tool": "python_executor_tool_id",
      "inputs": {
        "code": "{{step_1_output}}"
      }
    },
    {
      "step_id": "validate_result",
      "description": "Проверить результат тестирования",
      "type": "validation",
      "agent": "validator_agent_id",
      "inputs": {
        "test_result": "{{step_2_output}}"
      }
    }
  ]
}
```

## Преимущества

1. **Специализация** - каждый шаг может использовать специализированного агента
2. **Переиспользование** - инструменты можно использовать в разных планах
3. **Гибкость** - можно комбинировать агентов, инструменты и LLM
4. **Надежность** - автоматический fallback при ошибках
5. **Метрики** - полная трассировка выполнения

## Следующие шаги

- [ ] Веб-интерфейс для назначения агентов и инструментов шагам
- [ ] Автоматический подбор агентов и инструментов на основе описания шага
- [ ] Цепочки инструментов (output одного → input другого)
- [ ] Параллельное выполнение шагов с разными агентами
- [ ] A/B тестирование агентов в планах


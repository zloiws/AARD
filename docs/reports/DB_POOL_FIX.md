# Исправление проблемы с пулом соединений БД в WebSocket

## Проблема

При множественных WebSocket соединениях возникала ошибка:
```
QueuePool limit of size 20 overflow 10 reached, connection timed out
```

Это происходило потому, что:
1. Каждое WebSocket соединение создавало одну сессию БД
2. Сессия держалась открытой в бесконечном цикле опроса (каждые 500ms)
3. При множественных соединениях все соединения из пула были заняты
4. Новые запросы не могли получить соединение

## Решение

Изменена функция `poll_and_send_events`:
- **До**: Использовала одну сессию БД, переданную как параметр, которая держалась открытой
- **После**: Создает новую сессию для каждого запроса к БД и сразу закрывает её после использования

### Изменения

1. Убран параметр `db: Session` из функции `poll_and_send_events`
2. Внутри цикла создается новая сессия для каждого запроса
3. Сессия закрывается в блоке `finally` сразу после получения данных
4. События конвертируются в словари пока сессия открыта
5. Отправка событий происходит после закрытия сессии

### Преимущества

- ✅ Соединения освобождаются сразу после использования
- ✅ Пул соединений не переполняется
- ✅ Поддерживается больше одновременных WebSocket соединений
- ✅ Более эффективное использование ресурсов БД

## Файлы

- `backend/app/api/routes/websocket_events.py` - исправлена функция `poll_and_send_events`

# Тестирование логики планирования

## Обзор

Созданы тесты для проверки работы планирования с интеграцией Digital Twin. Тесты организованы от простого к сложному.

## Запуск тестов

### Вариант 1: Интерактивный пошаговый запуск

Запустите скрипт для выбора теста:

```bash
cd backend
python scripts/test_planning_step_by_step.py
```

Выберите:
- `1` - Тест 1: Простая задача
- `2` - Тест 2: Проверка Digital Twin
- `3` - Тест 3: Планирование с артефактами
- `4` - Тест 4: Сложная задача
- `5` - Тест 5: Восстановление после ошибок
- `all` - Запустить все тесты последовательно

### Вариант 2: Запуск всех тестов сразу

```bash
cd backend
python scripts/run_planning_tests.py
```

### Вариант 3: Использование pytest

```bash
cd backend
pytest tests/integration/test_planning_digital_twin.py -v
```

## Описание тестов

### Тест 1: Простая задача ✅

**Цель:** Проверить создание плана для простой задачи

**Что проверяется:**
- Создание задачи и плана
- Наличие шагов в плане
- Структура шагов (step_id, description, type, etc.)
- Статус плана

**Задача:** "Create a simple Python script that prints 'Hello, World!'"

**Ожидаемый результат:**
- План создан успешно
- В плане есть хотя бы 1 шаг
- Все шаги имеют обязательные поля

### Тест 2: Digital Twin контекст ✅

**Цель:** Проверить, что Digital Twin контекст создается и заполняется

**Что проверяется:**
- Создание контекста задачи
- Наличие всех обязательных полей в контексте
- Корректность сохраненных данных

**Ожидаемый результат:**
- Контекст содержит:
  - `original_user_request`
  - `active_todos`
  - `plan` (с plan_id, version)
  - `artifacts`, `execution_logs`, `interaction_history`, `metadata`

### Тест 3: Планирование с артефактами ✅

**Цель:** Проверить использование существующих артефактов при планировании

**Что проверяется:**
- Сохранение артефактов в контекст
- Репланирование с учетом артефактов
- Сохранение артефактов при репланировании

**Ожидаемый результат:**
- Артефакты сохраняются в Digital Twin контекст
- Новый план учитывает существующие артефакты
- Версия плана увеличивается

### Тест 4: Сложная задача ✅

**Цель:** Проверить планирование сложной задачи с множеством шагов

**Что проверяется:**
- Создание плана для сложной задачи
- Количество и структура шагов
- Стратегия планирования
- Уникальность step_id

**Задача:** "Create a complete e-commerce application with..."

**Ожидаемый результат:**
- План содержит много шагов (> 3)
- Все step_id уникальны
- Стратегия содержит подход, предположения, ограничения

### Тест 5: Восстановление после ошибок ✅

**Цель:** Проверить репланирование после ошибок выполнения

**Что проверяется:**
- Логирование ошибок в Digital Twin контекст
- Репланирование с учетом ошибок
- Адресация ошибок в новом плане

**Ожидаемый результат:**
- Ошибки сохраняются в `execution_logs`
- Новый план создается
- Новый план учитывает предыдущие ошибки

## Что проверяется в каждом тесте

### Базовая функциональность
- ✅ Создание плана
- ✅ Структура плана (goal, strategy, steps)
- ✅ Валидация шагов

### Digital Twin интеграция
- ✅ Создание контекста
- ✅ Сохранение исходного запроса
- ✅ Обновление контекста
- ✅ Сохранение истории взаимодействий

### Логика планирования
- ✅ Использование контекста в промптах
- ✅ Парсинг JSON ответов
- ✅ Репланирование
- ✅ Обработка ошибок

## Результаты тестов

После запуска теста вы увидите:

```
✅ Test 1 PASSED: Simple task planned
   Plan ID: <uuid>
   Steps: 3
   Status: draft
```

## Отладка

Если тест не проходит:

1. **Проверьте логи приложения:**
   ```bash
   # Логи должны показать промпты и ответы моделей
   ```

2. **Проверьте базу данных:**
   ```sql
   SELECT id, description, status FROM tasks ORDER BY created_at DESC LIMIT 1;
   SELECT context FROM tasks WHERE id = '<task_id>';
   ```

3. **Проверьте модель:**
   - Убедитесь, что модель gemma3:4b доступна
   - Проверьте, что Server 2 - Coding активен

## Следующие шаги

После успешного прохождения всех тестов:

1. Проверьте качество генерируемых планов
2. Убедитесь, что контекст используется в промптах
3. Проверьте работу с реальными задачами через UI

## Примечания

- Тесты используют реальную модель, поэтому могут занимать время
- Убедитесь, что база данных доступна и миграции применены
- Для тестирования лучше использовать тестовую базу данных


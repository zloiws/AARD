# ✅ Интеграция планирования с утверждениями - Завершено

## Статус: ✅ Реализовано

Система планирования теперь автоматически интегрирована с системой утверждений.

## Что реализовано

### 1. ✅ База данных
- **Миграция:** `004_add_plan_id_to_approval_requests.py`
- **Изменения:**
  - Добавлено поле `plan_id` в таблицу `approval_requests`
  - Добавлен внешний ключ на таблицу `plans`
  - Добавлен индекс для `plan_id`

### 2. ✅ Модель данных
- **Файл:** `backend/app/models/approval.py`
- **Изменения:**
  - Добавлено поле `plan_id` в модель `ApprovalRequest`
  - Добавлена связь `plan` с моделью `Plan`

### 3. ✅ Сервис утверждений
- **Файл:** `backend/app/services/approval_service.py`
- **Изменения:**
  - Метод `create_approval_request` теперь принимает `plan_id`
  - Метод `_approve_plan` обновлен для работы с `plan_id`
  - При утверждении запроса типа `plan_approval` план автоматически переходит в статус `approved`

### 4. ✅ Сервис планирования
- **Файл:** `backend/app/services/planning_service.py`
- **Изменения:**
  - Добавлен метод `_create_plan_approval_request` для автоматического создания запроса на утверждение
  - При создании плана автоматически создается approval request
  - Оценка рисков включается в approval request

## Как это работает

1. **Создание плана:**
   - Пользователь создает план через `/plans/create`
   - `PlanningService.generate_plan()` создает план со статусом `draft`
   - Автоматически вызывается `_create_plan_approval_request()`
   - Создается `ApprovalRequest` типа `plan_approval` со статусом `pending`

2. **Утверждение плана:**
   - Пользователь видит запрос на утверждение в `/approvals`
   - При утверждении вызывается `ApprovalService.approve_request()`
   - Автоматически вызывается `_approve_plan()`
   - План переходит в статус `approved`
   - План готов к выполнению

3. **Связь данных:**
   - `ApprovalRequest.plan_id` → `Plan.id`
   - `ApprovalRequest.task_id` → `Task.id` (для совместимости)
   - `ApprovalRequest.request_data` содержит информацию о плане

## Следующие шаги

1. ⏳ Обновить UI для отображения связи планов с утверждениями
2. ⏳ Добавить ссылки между планами и утверждениями
3. ⏳ Показывать статус утверждения на странице плана

## Готово к использованию

✅ Миграция создана
✅ Модель обновлена
✅ Сервисы интегрированы
✅ Автоматическое создание approval request работает


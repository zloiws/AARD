{% extends "base.html" %}

{% block title %}–°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">üìã –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–ª–∞–Ω</h4>
                </div>
                <div class="card-body">
                    <form id="createPlanForm" onsubmit="createPlan(event)">
                        <div class="mb-3">
                            <label for="task_description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ *</label>
                            <textarea 
                                class="form-control" 
                                id="task_description" 
                                name="task_description" 
                                rows="5" 
                                required
                                placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω..."></textarea>
                            <div class="form-text">
                                –ß–µ–º –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ, —Ç–µ–º –ª—É—á—à–µ –±—É–¥–µ—Ç –ø–ª–∞–Ω
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="context" class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (JSON, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <textarea 
                                class="form-control font-monospace" 
                                id="context" 
                                name="context" 
                                rows="3"
                                placeholder='{"language": "Python", "requirements": "..."}'></textarea>
                            <div class="form-text">
                                –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 1-5 –º–∏–Ω—É—Ç. 
                            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.
                        </div>

                        <div id="progressContainer" style="display: none;">
                            <div class="progress mb-3">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%">
                                    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–∞...
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="/plans" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> –û—Ç–º–µ–Ω–∞
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="bi bi-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function createPlan(event) {
    event.preventDefault();
    
    const form = event.target;
    const submitBtn = document.getElementById('submitBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    
    // Get form data
    const taskDescription = document.getElementById('task_description').value;
    const contextText = document.getElementById('context').value;
    
    let context = null;
    if (contextText.trim()) {
        try {
            context = JSON.parse(contextText);
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ –≤ JSON –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ: ' + e.message);
            return;
        }
    }
    
    // Disable form
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –°–æ–∑–¥–∞–Ω–∏–µ...';
    progressContainer.style.display = 'block';
    
    // Simulate progress (since we can't track real progress easily)
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 2;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
    }, 1000);
    
    try {
        const response = await fetch('/api/plans/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                task_description: taskDescription,
                context: context
            })
        });
        
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressBar.textContent = '–ó–∞–≤–µ—Ä—à–µ–Ω–æ!';
        
        if (response.ok) {
            const plan = await response.json();
            // Redirect to plan detail page
            window.location.href = `/plans/${plan.id}`;
        } else {
            const error = await response.json();
            alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞: ' + error.detail);
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω';
            progressContainer.style.display = 'none';
        }
    } catch (error) {
        clearInterval(progressInterval);
        alert('–û—à–∏–±–∫–∞: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω';
        progressContainer.style.display = 'none';
    }
}
</script>
{% endblock %}


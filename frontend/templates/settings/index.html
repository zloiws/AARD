{% extends "base.html" %}

{% block title %}System Settings{% endblock %}

{% block body_class %}iframe-page{% endblock %}

{% block extra_css %}
<style>
    body.iframe-page {
        background: #f8f9fa;
        padding: 0;
        margin: 0;
        min-height: auto;
        display: block;
    }
    
    .settings-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .settings-header {
        margin-bottom: 30px;
    }
    
    .settings-header h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        color: #212529;
    }
    
    .settings-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .settings-tab {
        padding: 12px 24px;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 16px;
        color: #6c757d;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
    }
    
    .settings-tab:hover {
        color: #667eea;
    }
    
    .settings-tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
    }
    
    .tab-content {
        display: none;
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .tab-content.active {
        display: block;
    }
    
    .setting-group {
        margin-bottom: 30px;
    }
    
    .setting-group-title {
        font-size: 18px;
        font-weight: 600;
        color: #212529;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .setting-item:last-child {
        border-bottom: none;
    }
    
    .setting-info {
        flex: 1;
    }
    
    .setting-name {
        font-size: 14px;
        font-weight: 500;
        color: #212529;
        margin-bottom: 4px;
    }
    
    .setting-description {
        font-size: 13px;
        color: #6c757d;
    }
    
    .setting-control {
        margin-left: 20px;
    }
    
    /* Toggle switch */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 52px;
        height: 28px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 28px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    
    .toggle-switch input:checked + .toggle-slider {
        background-color: #667eea;
    }
    
    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(24px);
    }
    
    /* Select dropdown */
    .setting-select {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        cursor: pointer;
        min-width: 120px;
    }
    
    .setting-select:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .tab-count {
        display: inline-block;
        background: #e9ecef;
        color: #495057;
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 12px;
        margin-left: 6px;
        font-weight: 600;
    }
    
    .settings-tab.active .tab-count {
        background: #667eea;
        color: white;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 20px;
    }
    
    .success-message {
        background: #d4edda;
        color: #155724;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 20px;
    }
    
    .module-search {
        margin-bottom: 20px;
    }
    
    .module-search input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
    }
    
    .module-search input:focus {
        outline: none;
        border-color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="settings-header">
        <h1>System Settings</h1>
        <p style="color: #6c757d;">Manage feature flags, logging levels, and module settings</p>
    </div>
    
    <div id="message-area"></div>
    
    <!-- Action buttons -->
    <div id="action-buttons" style="display: none; margin-bottom: 20px; padding: 16px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong style="color: #856404;">Unsaved Changes</strong>
                <p style="margin: 4px 0 0 0; color: #856404; font-size: 14px;">You have unsaved changes. Click "Apply Changes" to save them.</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="cancelChanges()" style="padding: 10px 20px; border: 1px solid #6c757d; background: white; color: #6c757d; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                    Cancel
                </button>
                <button onclick="applyChanges()" style="padding: 10px 20px; border: none; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                    Apply Changes
                </button>
            </div>
        </div>
    </div>
    
    <div class="settings-tabs">
        <button class="settings-tab active" onclick="showTab('features')">
            Feature Flags <span id="features-count" class="tab-count"></span>
        </button>
        <button class="settings-tab" onclick="showTab('logging')">
            Logging Levels <span id="logging-count" class="tab-count"></span>
        </button>
        <button class="settings-tab" onclick="showTab('modules')">
            Module Settings <span id="modules-count" class="tab-count"></span>
        </button>
    </div>
    
    <!-- Feature Flags Tab -->
    <div id="features-tab" class="tab-content active">
        <div class="setting-group">
            <div class="setting-group-title">Feature Flags</div>
            <div id="feature-flags-list">
                <div class="loading">Loading feature flags...</div>
            </div>
        </div>
    </div>
    
    <!-- Logging Levels Tab -->
    <div id="logging-tab" class="tab-content">
        <div class="setting-group">
            <div class="setting-group-title">Global Log Level</div>
            <div id="global-log-level">
                <div class="loading">Loading...</div>
            </div>
        </div>
        
        <div class="setting-group">
            <div class="setting-group-title">Module Log Levels</div>
            <div class="module-search">
                <input type="text" id="module-search" placeholder="Search modules..." oninput="filterModules()">
            </div>
            <div id="module-log-levels">
                <div class="loading">Loading module log levels...</div>
            </div>
        </div>
    </div>
    
    <!-- Module Settings Tab -->
    <div id="modules-tab" class="tab-content">
        <div class="setting-group">
            <div class="setting-group-title">All Settings by Module</div>
            <div id="all-settings">
                <div class="loading">Loading all settings...</div>
            </div>
        </div>
    </div>
</div>

<script>
let featureFlags = {};
let logLevels = {};
let allModules = [];
let pendingChanges = {
    features: {},
    logging: {},
    system: {}
};
let hasUnsavedChanges = false;

// Show message
function showMessage(message, type = 'success') {
    const messageArea = document.getElementById('message-area');
    messageArea.innerHTML = `<div class="${type}-message">${message}</div>`;
    setTimeout(() => {
        messageArea.innerHTML = '';
    }, 3000);
}

// Show/hide action buttons
function toggleActionButtons(show) {
    const buttons = document.getElementById('action-buttons');
    if (buttons) {
        buttons.style.display = show ? 'block' : 'none';
    }
    hasUnsavedChanges = show;
}

// Tab switching
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.settings-tab').forEach(btn => btn.classList.remove('active'));
    
    // Show selected tab
    document.getElementById(`${tabName}-tab`).classList.add('active');
    
    // Find and activate the clicked button
    document.querySelectorAll('.settings-tab').forEach(btn => {
        if (btn.textContent.toLowerCase().includes(tabName)) {
            btn.classList.add('active');
        }
    });
}

// Load feature flags
async function loadFeatureFlags() {
    const container = document.getElementById('feature-flags-list');
    try {
        console.log('Loading feature flags...');
        const response = await fetch('/api/settings/features/all');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        featureFlags = await response.json();
        console.log('Feature flags loaded:', featureFlags);
        
        // Update count
        const countElement = document.getElementById('features-count');
        if (countElement) {
            countElement.textContent = Object.keys(featureFlags).length;
        }
        
        if (Object.keys(featureFlags).length === 0) {
            container.innerHTML = '<p style="color: #6c757d; padding: 20px;">No feature flags configured yet.</p>';
            return;
        }
        
        const html = Object.entries(featureFlags).map(([feature, enabled]) => `
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">${feature.replace(/_/g, ' ').toUpperCase()}</div>
                    <div class="setting-description">Enable or disable ${feature.replace(/_/g, ' ')} feature</div>
                </div>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" ${enabled ? 'checked' : ''} onchange="toggleFeature('${feature}', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        `).join('');
        
        console.log('Rendering HTML, length:', html.length);
        container.innerHTML = html;
        console.log('Feature flags rendered successfully');
    } catch (error) {
        console.error('Error loading feature flags:', error);
        container.innerHTML = `<p style="color: #f44336; padding: 20px;">Error loading feature flags: ${error.message}</p>`;
        showMessage('Error loading feature flags', 'error');
    }
}

// Toggle feature flag (stage change)
function toggleFeature(feature, enabled) {
    pendingChanges.features[feature] = enabled;
    featureFlags[feature] = enabled; // Update local state for UI
    toggleActionButtons(true);
    console.log('Feature flag staged:', feature, enabled);
}

// Load log levels
async function loadLogLevels() {
    try {
        const response = await fetch('/api/settings/logging/all');
        logLevels = await response.json();
        
        // Update count
        document.getElementById('logging-count').textContent = Object.keys(logLevels).length;
        
        // Global level
        const globalLevel = logLevels._global || 'INFO';
        document.getElementById('global-log-level').innerHTML = `
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">Global Log Level</div>
                    <div class="setting-description">Default log level for all modules</div>
                </div>
                <div class="setting-control">
                    <select class="setting-select" onchange="setLogLevel(null, this.value)">
                        ${['DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL'].map(level => 
                            `<option value="${level}" ${level === globalLevel ? 'selected' : ''}>${level}</option>`
                        ).join('')}
                    </select>
                </div>
            </div>
        `;
        
        // Module levels
        allModules = Object.entries(logLevels).filter(([module]) => module !== '_global');
        renderModuleLevels(allModules);
    } catch (error) {
        console.error('Error loading log levels:', error);
        showMessage('Error loading log levels', 'error');
    }
}

// Render module log levels
function renderModuleLevels(modules) {
    const container = document.getElementById('module-log-levels');
    
    if (modules.length === 0) {
        container.innerHTML = '<p style="color: #6c757d; padding: 20px;">No module-specific log levels configured.</p>';
        return;
    }
    
    container.innerHTML = modules.map(([module, level]) => `
        <div class="setting-item" data-module="${module}">
            <div class="setting-info">
                <div class="setting-name">${module}</div>
            </div>
            <div class="setting-control">
                <select class="setting-select" onchange="setLogLevel('${module}', this.value)">
                    ${['DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL'].map(l => 
                        `<option value="${l}" ${l === level ? 'selected' : ''}>${l}</option>`
                    ).join('')}
                </select>
            </div>
        </div>
    `).join('');
}

// Filter modules
function filterModules() {
    const search = document.getElementById('module-search').value.toLowerCase();
    const filtered = allModules.filter(([module]) => module.toLowerCase().includes(search));
    renderModuleLevels(filtered);
}

// Set log level (stage change)
function setLogLevel(module, level) {
    const key = module || '_global';
    pendingChanges.logging[key] = level;
    logLevels[key] = level; // Update local state for UI
    toggleActionButtons(true);
    console.log('Log level staged:', key, level);
}

// Render a single setting item with edit capability
function renderSettingItem(s) {
    const isEditable = s.category === 'system';
    const isBoolean = s.value_type === 'boolean';
    const isInteger = s.value_type === 'integer';
    const isFloat = s.value_type === 'float';
    
    if (isEditable && isBoolean) {
        return `
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">${s.key}</div>
                    <div class="setting-description">${s.description || 'No description'}</div>
                </div>
                <div class="setting-control">
                    <label class="toggle-switch">
                        <input type="checkbox" ${s.value ? 'checked' : ''} onchange="updateSystemSetting('${s.key}', this.checked, 'boolean')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        `;
    } else if (isEditable && (isInteger || isFloat)) {
        return `
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">${s.key}</div>
                    <div class="setting-description">${s.description || 'No description'}</div>
                </div>
                <div class="setting-control">
                    <input type="number" 
                           value="${s.value}" 
                           ${isInteger ? 'step="1"' : 'step="0.1"'}
                           onchange="updateSystemSetting('${s.key}', ${isInteger ? 'parseInt(this.value)' : 'parseFloat(this.value)'}, '${s.value_type}')"
                           style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; width: 120px;">
                </div>
            </div>
        `;
    } else if (isEditable) {
        return `
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">${s.key}</div>
                    <div class="setting-description">${s.description || 'No description'}</div>
                </div>
                <div class="setting-control">
                    <input type="text" 
                           value="${s.value}" 
                           onchange="updateSystemSetting('${s.key}', this.value, '${s.value_type}')"
                           style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; min-width: 200px;">
                </div>
            </div>
        `;
    } else {
        // Read-only for feature/logging (managed via dedicated tabs)
        return `
            <div class="setting-item">
                <div class="setting-info">
                    <div class="setting-name">${s.key}</div>
                    <div class="setting-description">${s.description || 'No description'}</div>
                </div>
                <div class="setting-control">
                    <span style="font-family: monospace; color: #667eea;">${JSON.stringify(s.value)}</span>
                </div>
            </div>
        `;
    }
}

// Update system setting (stage change)
function updateSystemSetting(key, value, valueType) {
    pendingChanges.system[key] = { value, valueType };
    toggleActionButtons(true);
    console.log('System setting staged:', key, value);
}

// Load all settings
async function loadAllSettings() {
    try {
        const response = await fetch('/api/settings/');
        const settings = await response.json();
        
        // Update count
        document.getElementById('modules-count').textContent = settings.length;
        
        const container = document.getElementById('all-settings');
        if (settings.length === 0) {
            container.innerHTML = '<p style="color: #6c757d; padding: 20px;">No settings found.</p>';
            return;
        }
        
        // Group by category
        const grouped = settings.reduce((acc, s) => {
            if (!acc[s.category]) acc[s.category] = [];
            acc[s.category].push(s);
            return acc;
        }, {});
        
        container.innerHTML = Object.entries(grouped).map(([category, items]) => `
            <div style="margin-bottom: 30px;">
                <h3 style="font-size: 16px; color: #667eea; margin-bottom: 12px;">${category.toUpperCase()}</h3>
                ${items.map(s => renderSettingItem(s)).join('')}
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading all settings:', error);
        showMessage('Error loading settings', 'error');
    }
}

// Apply all pending changes
async function applyChanges() {
    console.log('Applying changes...', pendingChanges);
    
    const errors = [];
    let successCount = 0;
    
    try {
        // Apply system setting changes
        for (const [key, data] of Object.entries(pendingChanges.system)) {
            try {
                const response = await fetch('/api/settings/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        key: key,
                        value: data.value,
                        category: 'system',
                        value_type: data.valueType
                    })
                });
                
                if (response.ok) {
                    successCount++;
                } else {
                    errors.push(`Setting "${key}": ${response.statusText}`);
                }
            } catch (error) {
                errors.push(`Setting "${key}": ${error.message}`);
            }
        }
        
        // Apply feature flag changes
        for (const [feature, enabled] of Object.entries(pendingChanges.features)) {
            try {
                const response = await fetch('/api/settings/features/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({feature, enabled})
                });
                
                if (response.ok) {
                    successCount++;
                } else {
                    errors.push(`Feature "${feature}": ${response.statusText}`);
                }
            } catch (error) {
                errors.push(`Feature "${feature}": ${error.message}`);
            }
        }
        
        // Apply logging changes
        for (const [key, level] of Object.entries(pendingChanges.logging)) {
            const module = key === '_global' ? null : key;
            try {
                const response = await fetch('/api/settings/logging/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({module, level})
                });
                
                if (response.ok) {
                    successCount++;
                } else {
                    errors.push(`Log level "${key}": ${response.statusText}`);
                }
            } catch (error) {
                errors.push(`Log level "${key}": ${error.message}`);
            }
        }
        
        // Clear pending changes
        pendingChanges.features = {};
        pendingChanges.logging = {};
        pendingChanges.system = {};
        toggleActionButtons(false);
        
        // Show result
        if (errors.length === 0) {
            showMessage(`âœ“ Successfully applied ${successCount} change(s)`);
        } else {
            showMessage(`Applied ${successCount} change(s) with ${errors.length} error(s). Check console.`, 'error');
            console.error('Errors:', errors);
        }
        
        // Reload data to ensure consistency
        setTimeout(() => {
            loadFeatureFlags();
            loadLogLevels();
            loadAllSettings(); // Reload module settings too
        }, 500);
        
    } catch (error) {
        console.error('Error applying changes:', error);
        showMessage('Error applying changes', 'error');
    }
}

// Cancel pending changes
function cancelChanges() {
    console.log('Canceling changes...');
    
    // Clear pending changes
    pendingChanges.features = {};
    pendingChanges.logging = {};
    pendingChanges.system = {};
    toggleActionButtons(false);
    
    // Reload original data
    loadFeatureFlags();
    loadLogLevels();
    loadAllSettings();
    
    showMessage('Changes canceled', 'success');
}

// Warn before leaving with unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
    }
});

// Load on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, starting to load settings...');
    
    // Check if containers exist
    const featureContainer = document.getElementById('feature-flags-list');
    const globalLogLevel = document.getElementById('global-log-level');
    const allSettings = document.getElementById('all-settings');
    
    console.log('Containers found:', {
        featureContainer: !!featureContainer,
        globalLogLevel: !!globalLogLevel,
        allSettings: !!allSettings
    });
    
    // Load all data at once
    loadFeatureFlags();
    loadLogLevels();
    loadAllSettings();
});
</script>
{% endblock %}

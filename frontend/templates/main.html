{% extends "base.html" %}

{% block title %}AARD - Autonomous Agentic Recursive Development{% endblock %}

{% block extra_css %}
<style>
    /* Tab styles - redesigned with scrolling and new color palette */
    .tabs-container {
        position: relative;
        background: #ffffff;
        border-bottom: 2px solid #d1d5db;
        flex-shrink: 0;
        display: flex;
        align-items: center;
    }
    
    .tabs-scroll-button {
        background: #ffffff;
        border: none;
        border-right: 1px solid #e5e7eb;
        padding: 12px 8px;
        cursor: pointer;
        color: #374151;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 36px;
        transition: background 0.2s;
        flex-shrink: 0;
        z-index: 10;
    }
    
    .tabs-scroll-button:hover {
        background: #f3f4f6;
    }
    
    .tabs-scroll-button:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }
    
    .tabs-wrapper {
        flex: 1;
        overflow-x: auto;
        overflow-y: hidden;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: #d1d5db #ffffff;
    }
    
    .tabs-wrapper::-webkit-scrollbar {
        height: 4px;
    }
    
    .tabs-wrapper::-webkit-scrollbar-track {
        background: #ffffff;
    }
    
    .tabs-wrapper::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 2px;
    }
    
    .tabs {
        display: flex;
        gap: 0;
        padding: 0;
        background: #ffffff;
        min-width: max-content;
    }
    
    .tab {
        padding: 12px 20px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #6b7280;
        transition: all 0.2s;
        position: relative;
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    .tab:hover {
        background: #f9fafb;
        color: #111827;
    }
    
    .tab.active {
        color: #1e40af;
        border-bottom-color: #3b82f6;
        background: #eff6ff;
        font-weight: 600;
    }
    
    .tab-divider {
        width: 1px;
        background: #e5e7eb;
        margin: 8px 4px;
        flex-shrink: 0;
    }
    
    .tab-content {
        display: none;
        flex: 1;
        overflow: hidden;
        min-height: 0;
    }
    
    .tab-content.active {
        display: flex;
        flex-direction: column;
    }
    
    /* Chat container */
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 0;
        overflow: hidden;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 20px;
        background: #f8f9fa;
        min-height: 0;
        scroll-behavior: smooth;
    }
    
    .chat-input-container {
        flex-shrink: 0;
        background: white;
        border-top: 1px solid #e9ecef;
        padding: 16px 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    /* Model selection panel */
    .model-selection-panel {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .model-selection-panel.collapsed {
        display: none;
    }
    
    .model-selection-panel label {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 13px;
        color: #495057;
    }
    
    .model-selection-panel select,
    .model-selection-panel input[type="number"] {
        padding: 6px 10px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        font-size: 14px;
    }
    
    /* Input form */
    .input-form-wrapper {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }
    
    textarea {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        font-size: 15px;
        font-family: inherit;
        resize: none;
        min-height: 50px;
        max-height: 150px;
        transition: border-color 0.2s;
        line-height: 1.5;
    }
    
    textarea:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .action-buttons {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
    }
    
    button[type="submit"] {
        padding: 12px 24px;
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    button[type="submit"]:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    button[type="submit"]:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .toggle-panel-btn {
        padding: 12px;
        background: #e9ecef;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
    }
    
    .stop-button {
        padding: 12px 24px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
    }
    
    .stop-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* Message styles */
    .message {
        margin-bottom: 16px;
        display: flex;
        flex-direction: column;
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .message.user {
        align-items: flex-end;
    }
    
    .message.assistant {
        align-items: flex-start;
    }
    
    .message-content {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
        word-break: break-word;
        line-height: 1.5;
    }
    
    .message.user .message-content {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .message.assistant .message-content {
        background: white;
        color: #212529;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-bottom-left-radius: 4px;
    }
    
    .message-meta {
        font-size: 12px;
        color: #6c757d;
        margin-top: 4px;
        padding: 0 8px;
    }
    
    .message.user .message-meta {
        text-align: right;
    }
    
    .loading {
        display: none;
        padding: 12px 16px;
        background: white;
        border-radius: 18px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    
    .loading.show {
        display: block;
    }
    
    .loading-dots {
        display: flex;
        gap: 5px;
    }
    
    .loading-dots span {
        width: 8px;
        height: 8px;
        background: #2563eb;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }
    
    .loading-dots span:nth-child(1) {
        animation-delay: -0.32s;
    }
    
    .loading-dots span:nth-child(2) {
        animation-delay: -0.16s;
    }
    
    @keyframes bounce {
        0%, 80%, 100% {
            transform: scale(0);
        }
        40% {
            transform: scale(1);
        }
    }
    
    /* Tab content for approvals and artifacts */
    .tab-content > iframe {
        width: 100%;
        height: 100%;
        border: none;
    }
    
    .tab-content > div {
        padding: 20px;
        overflow-y: auto;
        height: 100%;
    }
    
    /* Model Logs Tab Styles */
    .model-logs-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
        background: #f8f9fa;
    }
    
    .model-logs-header {
        padding: 16px 20px;
        background: white;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    
    .model-logs-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .model-logs-controls button {
        padding: 8px 16px;
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
    }
    
    .model-logs-controls button:hover {
        background: #1d4ed8;
    }
    
    /* Links styling - different from tabs */
    a {
        color: #059669;
        text-decoration: none;
        transition: color 0.2s;
    }
    
    a:hover {
        color: #047857;
        text-decoration: underline;
    }
    
    a:visited {
        color: #0d9488;
    }
    
    /* Markdown links */
    .markdown-body a {
        color: #059669;
    }
    
    .markdown-body a:hover {
        color: #047857;
        text-decoration: underline;
    }
    
    .model-logs-controls button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    .model-logs-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
    }
    
    .log-entry {
        background: white;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #2563eb;
    }
    
    .log-entry-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .log-entry-model {
        font-weight: 600;
        color: #059669;
        font-size: 14px;
    }
    
    .log-entry-time {
        font-size: 12px;
        color: #6c757d;
    }
    
    .log-entry-type {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        margin-left: 8px;
    }
    
    .log-entry-type.request {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .log-entry-type.response {
        background: #e8f5e9;
        color: #388e3c;
    }
    
    .log-entry-type.thinking {
        background: #fff3e0;
        color: #f57c00;
    }
    
    .log-entry-type.error {
        background: #ffebee;
        color: #c62828;
    }
    
    .log-entry-content {
        margin-top: 12px;
    }
    
    .log-entry-content pre {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 12px;
        overflow-x: auto;
        font-size: 13px;
        line-height: 1.5;
        margin: 8px 0;
    }
    
    .log-entry-content .json-view {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 12px;
        overflow-x: auto;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.5;
    }
    
    .log-entry-metadata {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #e9ecef;
        font-size: 12px;
        color: #6c757d;
    }
    
    .log-entry-metadata span {
        margin-right: 16px;
    }
    
    .empty-logs {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }
    
    .empty-logs-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    
    /* Dashboard iframe improvements */
    .dashboard-iframe-wrapper {
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: white;
    }
    
    .dashboard-iframe-wrapper iframe {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <div>
            <h1>AARD</h1>
            <div class="status">Autonomous Agentic Recursive Development</div>
        </div>
        <div>
            <span id="model-status">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
    </div>
    
    <div class="tabs-container">
        <button class="tabs-scroll-button" id="tabs-scroll-left" onclick="scrollTabs(-200)" title="–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–ª–µ–≤–æ">‚Äπ</button>
        <div class="tabs-wrapper" id="tabs-wrapper">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('chat')">üí¨ –ß–∞—Ç</div>
                <div class="tab" onclick="switchTab('current-work')">‚öôÔ∏è –¢–µ–∫—É—â–∞—è —Ä–∞–±–æ—Ç–∞</div>
                <div class="tab" onclick="switchTab('model-logs')">üîç –õ–æ–≥–∏ –º–æ–¥–µ–ª–µ–π</div>
                <div class="tab-divider"></div>
                <div class="tab" onclick="switchTab('dashboard')">üìä Dashboard</div>
                <div class="tab" onclick="switchTab('plans')">üìã –ü–ª–∞–Ω—ã</div>
                <div class="tab" onclick="switchTab('approvals')">‚úÖ –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</div>
                <div class="tab-divider"></div>
                <div class="tab" onclick="switchTab('artifacts')">üì¶ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã</div>
                <div class="tab" onclick="switchTab('agents')">ü§ñ –ê–≥–µ–Ω—Ç—ã</div>
                <div class="tab" onclick="switchTab('tools')">üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
                <div class="tab-divider"></div>
                <div class="tab" onclick="switchTab('agent-gym')">üèãÔ∏è Agent Gym</div>
                <div class="tab" onclick="switchTab('traces')">üîç –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏</div>
                <div class="tab-divider"></div>
                <div class="tab" onclick="switchTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>
        </div>
        <button class="tabs-scroll-button" id="tabs-scroll-right" onclick="scrollTabs(200)" title="–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–ø—Ä–∞–≤–æ">‚Ä∫</button>
    </div>
    
    <!-- Chat Tab -->
    <div id="chat-tab" class="tab-content active">
        <div class="chat-container">
            <div class="chat-messages" id="messages">
                <div class="message assistant">
                    <div class="message-content">
                        –ü—Ä–∏–≤–µ—Ç! –Ø AARD - –≤–∞—à AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ó–∞–≥—Ä—É–∂–∞—é –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏...
                    </div>
                    <div class="message-meta">–°–∏—Å—Ç–µ–º–∞</div>
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="model-selection-panel" id="model-panel">
                    <label>
                        –°–µ—Ä–≤–µ—Ä:
                        <select name="server_id" id="server_select" onchange="loadServerModels()">
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                        </select>
                    </label>
                    <label>
                        –ú–æ–¥–µ–ª—å:
                        <select name="model" id="model_select">
                            <option value="">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä</option>
                        </select>
                    </label>
                    <label>
                        –¢–∏–ø –∑–∞–¥–∞—á–∏:
                        <select name="task_type" id="task_type">
                            <option value="general_chat">–û–±—â–∏–π —á–∞—Ç</option>
                            <option value="code_generation">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞</option>
                            <option value="code_analysis">–ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞</option>
                            <option value="reasoning">–†–∞—Å—Å—É–∂–¥–µ–Ω–∏—è</option>
                            <option value="planning">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</option>
                            <option value="text_generation">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞</option>
                        </select>
                    </label>
                    <label>
                        Temperature:
                        <input type="number" name="temperature" id="temperature" value="0.7" min="0" max="2" step="0.1">
                    </label>
                </div>
                
                <form 
                    id="chat-form"
                    onsubmit="return handleSubmit(event)"
                >
                    <div class="input-form-wrapper">
                        <div class="input-wrapper">
                            <textarea 
                                name="message" 
                                id="message-input" 
                                placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                                required
                                rows="1"
                                onkeydown="handleTextareaKeydown(event)"
                            ></textarea>
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="toggle-panel-btn" onclick="toggleModelPanel()" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏">
                                ‚öôÔ∏è
                            </button>
                            <button type="submit" id="submit-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                            <button type="button" class="stop-button" id="stop-btn" onclick="stopGeneration()" disabled>‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Current Work Tab -->
    <div id="current-work-tab" class="tab-content">
        <div class="model-logs-container">
            <div class="model-logs-header">
                <h2 style="margin: 0; font-size: 20px;">‚öôÔ∏è –¢–µ–∫—É—â–∞—è —Ä–∞–±–æ—Ç–∞</h2>
                <div class="model-logs-controls">
                    <button onclick="loadCurrentWork()" id="refresh-current-work-btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                    <span id="current-work-status" style="font-size: 14px; color: #6c757d;"></span>
                </div>
            </div>
            <div class="model-logs-content" id="current-work-content">
                <div class="empty-logs">
                    <div class="empty-logs-icon">‚öôÔ∏è</div>
                    <p>–ü—Ä–æ—Ü–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</p>
                    <p style="font-size: 13px; margin-top: 8px;">–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Model Logs Tab -->
    <div id="model-logs-tab" class="tab-content">
        <div class="model-logs-container">
            <div class="model-logs-header">
                <h2 style="margin: 0; font-size: 20px;">üîç –õ–æ–≥–∏ –º–æ–¥–µ–ª–µ–π</h2>
                <div class="model-logs-controls">
                    <button onclick="loadModelLogsSummary()" id="refresh-logs-btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                    <button onclick="clearModelLogs()" id="clear-logs-btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </div>
            <div class="model-logs-content" id="model-logs-content">
                <!-- Current session logs container -->
                <div id="current-session-logs" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;"></div>
                <!-- Summary container -->
                <div id="summary-container" style="display: flex; flex-direction: column; gap: 20px;"></div>
                <!-- Empty state -->
                <div class="empty-logs" id="empty-logs-state">
                    <div class="empty-logs-icon">üîç</div>
                    <p>–ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ —Å —Ä–∞–∑–≤–µ—Ç–≤–ª–µ–Ω–∏—è–º–∏ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</p>
                    <p style="font-size: 13px; margin-top: 8px;">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–¥–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–¥–∞—á —Å–æ –≤—Å–µ–º–∏ —Ä–∞–∑–≤–µ—Ç–≤–ª–µ–Ω–∏—è–º–∏</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content">
        <div class="dashboard-iframe-wrapper">
            <iframe src="/dashboard" id="dashboard-iframe"></iframe>
        </div>
    </div>
    
    <!-- Plans Tab -->
    <div id="plans-tab" class="tab-content">
        <div style="width: 100%; height: 100%; overflow: hidden;">
            <iframe src="/plans" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>
    
    <!-- Approvals Tab -->
    <div id="approvals-tab" class="tab-content">
        <div>
            <iframe src="/approvals" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>
    
    <!-- Artifacts Tab -->
    <div id="artifacts-tab" class="tab-content">
        <div>
            <iframe src="/artifacts" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>
    
    <!-- Agents Tab -->
    <div id="agents-tab" class="tab-content">
        <div>
            <iframe src="/agents" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>
    
    <!-- Tools Tab -->
    <div id="tools-tab" class="tab-content">
        <div>
            <iframe src="/tools" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>
    
    <!-- Agent Gym Tab -->
    <div id="agent-gym-tab" class="tab-content">
        <div>
            <iframe src="/agent-gym" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>
    
    <!-- Traces Tab -->
    <div id="traces-tab" class="tab-content">
        <div style="width: 100%; height: 100%; overflow: hidden;">
            <iframe src="/traces" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>
    
    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content">
        <div style="width: 100%; height: 100%; overflow: hidden;">
            <iframe src="/settings" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>
</div>

<script>
    let currentSessionId = null;
    let modelPanelCollapsed = false;
    let currentGenerationAbortController = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadServers();
        
        const savedSession = localStorage.getItem('aard_session_id');
        if (savedSession) {
            currentSessionId = savedSession;
            // Load session history if session exists
            loadSessionHistory(savedSession);
        }
        
        // Load saved model logs from localStorage
        loadModelLogsFromStorage();
        
        const textarea = document.getElementById('message-input');
        if (textarea) {
            textarea.addEventListener('input', autoResizeTextarea);
            textarea.focus();
        }
    });
    
    // Load session history from database
    async function loadSessionHistory(sessionId) {
        try {
            const response = await fetch(`/api/chat/session/${sessionId}`);
            if (!response.ok) {
                if (response.status === 404) {
                    // Session not found, clear it
                    localStorage.removeItem('aard_session_id');
                    currentSessionId = null;
                    return;
                }
                console.error('Failed to load session history:', response.statusText);
                return;
            }
            
            const sessionData = await response.json();
            const messagesDiv = document.getElementById('messages');
            if (!messagesDiv) return;
            
            // Clear existing messages (except welcome message)
            messagesDiv.innerHTML = '';
            
            // Render all messages from session
            if (sessionData.messages && sessionData.messages.length > 0) {
                sessionData.messages.forEach(msg => {
                    if (msg.role === 'user') {
                        // Add user message
                        const userMsgDiv = document.createElement('div');
                        userMsgDiv.className = 'message user';
                        userMsgDiv.innerHTML = `
                            <div class="message-content">${escapeHtml(msg.content)}</div>
                            <div class="message-meta">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                        `;
                        messagesDiv.appendChild(userMsgDiv);
                    } else if (msg.role === 'assistant') {
                        // Add assistant message
                        const assistantMsgDiv = document.createElement('div');
                        assistantMsgDiv.className = 'message assistant';
                        assistantMsgDiv.innerHTML = `
                            <div class="message-content markdown-body" data-markdown data-model="${msg.model || 'unknown'}">${escapeHtml(msg.content)}</div>
                            <div class="message-meta">${msg.model || 'unknown'} ‚Ä¢ ${new Date(msg.timestamp).toLocaleTimeString()}</div>
                        `;
                        messagesDiv.appendChild(assistantMsgDiv);
                        
                        // Process markdown if available
                        const markdownContent = assistantMsgDiv.querySelector('[data-markdown]');
                        if (markdownContent && typeof marked !== 'undefined') {
                            const rawText = markdownContent.textContent || markdownContent.innerText;
                            markdownContent.innerHTML = marked.parse(rawText);
                            // Highlight code blocks
                            if (typeof hljs !== 'undefined') {
                                markdownContent.querySelectorAll('pre code').forEach((block) => {
                                    hljs.highlightElement(block);
                                });
                            }
                        }
                    }
                });
                
                // Scroll to bottom
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                console.log(`‚úÖ Loaded ${sessionData.messages.length} messages from session`);
            }
        } catch (error) {
            console.error('Error loading session history:', error);
        }
    }

    // Tab switching
    function switchTab(tabName, planId = null) {
        // Remove active class from all tabs and tab contents
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        const targetTab = document.getElementById(tabName + '-tab');
        if (targetTab) {
            targetTab.classList.add('active');
            
            // If switching to plans tab with a planId, navigate to that plan
            if (tabName === 'plans' && planId) {
                const iframe = targetTab.querySelector('iframe');
                if (iframe) {
                    iframe.src = `/plans/${planId}`;
                }
            }
            
            // If switching to current-work tab, load active tasks and start refresh
            if (tabName === 'current-work') {
                if (typeof loadCurrentWork === 'function') {
                    loadCurrentWork();
                }
                setTimeout(() => {
                    if (typeof window.startCurrentWorkRefresh === 'function') {
                        window.startCurrentWorkRefresh();
                    }
                }, 100);
            } else {
                if (typeof window.stopCurrentWorkRefresh === 'function') {
                    window.stopCurrentWorkRefresh();
                }
            }
            
            // If switching to model-logs tab, load summary if not already loaded
            if (tabName === 'model-logs') {
                const summaryContainer = document.getElementById('summary-container');
                if (summaryContainer && summaryContainer.children.length === 0) {
                    setTimeout(() => {
                        if (typeof loadModelLogsSummary === 'function') {
                            loadModelLogsSummary();
                        }
                    }, 100);
                }
            }
        }
        
        // Find and activate the correct tab button
        const tabs = document.querySelectorAll('.tab');
        let activeTabElement = null;
        
        tabs.forEach(tab => {
            const tabText = tab.textContent.trim();
            const tabMapping = {
                'chat': 'üí¨ –ß–∞—Ç',
                'current-work': '‚öôÔ∏è –¢–µ–∫—É—â–∞—è —Ä–∞–±–æ—Ç–∞',
                'model-logs': 'üîç –õ–æ–≥–∏ –º–æ–¥–µ–ª–µ–π',
                'dashboard': 'üìä Dashboard',
                'plans': 'üìã –ü–ª–∞–Ω—ã',
                'approvals': '‚úÖ –£—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è',
                'artifacts': 'üì¶ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã',
                'agents': 'ü§ñ –ê–≥–µ–Ω—Ç—ã',
                'tools': 'üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã',
                'agent-gym': 'üèãÔ∏è Agent Gym',
                'traces': 'üîç –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏',
                'settings': '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏'
            };
            
            if (tabText === tabMapping[tabName]) {
                tab.classList.add('active');
                activeTabElement = tab;
            }
        });
        
        // Scroll to active tab if needed
        if (activeTabElement && typeof scrollToTab === 'function') {
            scrollToTab(activeTabElement);
        }
        
        // Update scroll buttons visibility
        if (typeof updateScrollButtons === 'function') {
            updateScrollButtons();
        }
    }
    
    // Make switchTab globally available
    window.switchTab = switchTab;
    
    // Scroll tabs horizontally
    function scrollTabs(direction) {
        const tabsWrapper = document.getElementById('tabs-wrapper');
        if (!tabsWrapper) return;
        
        const scrollAmount = direction;
        tabsWrapper.scrollBy({
            left: scrollAmount,
            behavior: 'smooth'
        });
        
        // Update button states after scroll
        setTimeout(updateScrollButtons, 300);
    }
    
    // Scroll to specific tab
    function scrollToTab(tabElement) {
        const tabsWrapper = document.getElementById('tabs-wrapper');
        if (!tabsWrapper || !tabElement) return;
        
        const wrapperRect = tabsWrapper.getBoundingClientRect();
        const tabRect = tabElement.getBoundingClientRect();
        
        // Check if tab is visible
        const isVisible = tabRect.left >= wrapperRect.left && tabRect.right <= wrapperRect.right;
        
        if (!isVisible) {
            // Scroll to make tab visible
            const scrollLeft = tabElement.offsetLeft - tabsWrapper.offsetLeft - (wrapperRect.width / 2) + (tabRect.width / 2);
            tabsWrapper.scrollTo({
                left: scrollLeft,
                behavior: 'smooth'
            });
        }
        
        // Update button states
        setTimeout(updateScrollButtons, 300);
    }
    
    // Update scroll button states based on scroll position
    function updateScrollButtons() {
        const tabsWrapper = document.getElementById('tabs-wrapper');
        const scrollLeftBtn = document.getElementById('tabs-scroll-left');
        const scrollRightBtn = document.getElementById('tabs-scroll-right');
        
        if (!tabsWrapper) return;
        
        const canScrollLeft = tabsWrapper.scrollLeft > 0;
        const canScrollRight = tabsWrapper.scrollLeft < (tabsWrapper.scrollWidth - tabsWrapper.clientWidth - 1);
        
        if (scrollLeftBtn) {
            scrollLeftBtn.disabled = !canScrollLeft;
        }
        if (scrollRightBtn) {
            scrollRightBtn.disabled = !canScrollRight;
        }
    }
    
    // Initialize scroll buttons on load
    document.addEventListener('DOMContentLoaded', function() {
        const tabsWrapper = document.getElementById('tabs-wrapper');
        if (tabsWrapper) {
            // Update buttons on scroll
            tabsWrapper.addEventListener('scroll', updateScrollButtons);
            // Initial update
            updateScrollButtons();
        }
    });
    
    // Listen for messages from iframes (for navigation)
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'switchTab') {
            switchTab(event.data.tab, event.data.planId);
        }
    });

    // Toggle model selection panel
    function toggleModelPanel() {
        const panel = document.getElementById('model-panel');
        modelPanelCollapsed = !modelPanelCollapsed;
        panel.classList.toggle('collapsed', modelPanelCollapsed);
    }

    // Load servers from database
    async function loadServers() {
        try {
            const response = await fetch('/api/models/servers');
            const data = await response.json();
            
            const serverSelect = document.getElementById('server_select');
            if (!serverSelect) return;
            
            serverSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä...</option>';
            
            data.servers.forEach(server => {
                const option = document.createElement('option');
                option.value = server.id;  // Use server ID, not URL
                option.textContent = `${server.name || server.url} ${server.available ? '‚úì' : '‚úó'} (${server.models.length} –º–æ–¥–µ–ª–µ–π)`;
                option.dataset.available = server.available;
                serverSelect.appendChild(option);
            });
            
            if (data.servers.length > 0) {
                loadServerModels();
            }
        } catch (error) {
            console.error('Error loading servers:', error);
        }
    }

    // Load models for selected server
    async function loadServerModels() {
        const serverSelect = document.getElementById('server_select');
        const modelSelect = document.getElementById('model_select');
        
        if (!serverSelect || !modelSelect) return;
        
        const selectedServerId = serverSelect.value;
        
        if (!selectedServerId) {
            modelSelect.innerHTML = '<option value="">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä</option>';
            return;
        }
        
        // Show loading state
        modelSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π...</option>';
        modelSelect.disabled = true;
        
        try {
            console.log('Loading models for server:', selectedServerId);
            
            // Get models from selected server using API
            const response = await fetch(`/api/servers/${selectedServerId}/models`);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Failed to load models:', response.status, errorText);
                throw new Error(`Failed to load models: ${response.status}`);
            }
            
            const serverData = await response.json();
            console.log('Loaded models:', serverData);
            
            modelSelect.innerHTML = '<option value="">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä</option>';
            modelSelect.disabled = false;
            
            if (serverData && Array.isArray(serverData) && serverData.length > 0) {
                serverData.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.model_name || model.name;
                    option.textContent = `${model.name || model.model_name}${model.is_active ? '' : ' (–Ω–µ–∞–∫—Ç–∏–≤–Ω–∞)'}`;
                    if (!model.is_active) {
                        option.disabled = true;
                        option.style.color = '#999';
                    }
                    modelSelect.appendChild(option);
                });
                console.log(`Loaded ${serverData.length} models`);
            } else {
                // Try fallback: get from /api/models/servers
                console.log('No models in DB, trying fallback...');
                const serversResponse = await fetch('/api/models/servers');
                const serversData = await serversResponse.json();
                const selectedServer = serversData.servers.find(s => s.id === selectedServerId);
                
                if (selectedServer && selectedServer.models && selectedServer.models.length > 0) {
                    selectedServer.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.model || model.name;
                        option.textContent = `${model.name || model.model}`;
                        modelSelect.appendChild(option);
                    });
                    console.log(`Loaded ${selectedServer.models.length} models from fallback`);
                } else {
                    modelSelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π</option>';
                    console.warn('No models found for server');
                }
            }
        } catch (error) {
            console.error('Error loading models:', error);
            modelSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            modelSelect.disabled = false;
        }
    }

    // Auto-resize textarea
    function autoResizeTextarea() {
        const textarea = document.getElementById('message-input');
        if (textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }
    }

    // Handle textarea keydown
    function handleTextareaKeydown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            const form = document.getElementById('chat-form');
            if (form && !event.target.form.querySelector('#submit-btn').disabled) {
                form.requestSubmit();
            }
        }
    }

    // Handle form submit
    function handleSubmit(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        
        // Get values from selects
        const serverId = document.getElementById('server_select').value;
        const model = document.getElementById('model_select').value;
        const taskType = document.getElementById('task_type').value;
        const temperature = document.getElementById('temperature').value;
        const message = formData.get('message');
        
        if (!message || !message.trim()) {
            return false;
        }
        
        // Prepare request data
        const requestData = {
            message: message.trim(),
            task_type: taskType,
            temperature: parseFloat(temperature) || 0.7,
        };
        
        // Add session_id if exists
        if (currentSessionId) {
            requestData.session_id = currentSessionId;
        }
        
        // Add server_id and model if selected (only if not empty)
        if (serverId && serverId.trim()) {
            requestData.server_id = serverId.trim();
        }
        if (model && model.trim()) {
            requestData.model = model.trim();
        }
        
        console.log('Submitting chat request:', requestData);
        
        // Add request log
        addModelLog('request', model || 'Auto-select', message.trim(), {
            'Task Type': taskType,
            'Temperature': parseFloat(temperature) || 0.7,
            'Server ID': serverId || 'Auto-select',
            '–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞': '–ó–∞–≥—Ä—É–∑–∫–∞...'
        });
        
        // Show loading and enable stop button
        document.getElementById('loading').classList.add('show');
        document.getElementById('submit-btn').disabled = true;
        document.getElementById('stop-btn').disabled = false;
        
        // Create abort controller for cancellation
        currentGenerationAbortController = new AbortController();
        
        // Use fetch to submit with JSON, then use HTMX to swap response
        fetch('/api/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'text/html, application/json'
            },
            body: JSON.stringify(requestData),
            signal: currentGenerationAbortController.signal
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            // Try to get trace_id and session_id from response headers
            const traceId = response.headers.get('X-Trace-Id') || response.headers.get('trace-id') || null;
            const sessionId = response.headers.get('X-Session-Id') || null;
            return response.text().then(html => ({ html, traceId, sessionId }));
        })
        .then(({ html, traceId, sessionId }) => {
            // Save session_id if provided
            if (sessionId && sessionId !== currentSessionId) {
                currentSessionId = sessionId;
                localStorage.setItem('aard_session_id', sessionId);
                console.log('üíæ Saved session ID:', sessionId);
            }
            
            // Insert response into messages
            const messagesDiv = document.getElementById('messages');
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const messageElement = tempDiv.firstElementChild;
            messagesDiv.appendChild(messageElement);
            
            // Process markdown and syntax highlighting
            const markdownContent = messageElement.querySelector('[data-markdown]');
            if (markdownContent && typeof marked !== 'undefined') {
                const rawText = markdownContent.textContent || markdownContent.innerText;
                markdownContent.innerHTML = marked.parse(rawText);
                // Highlight code blocks
                if (typeof hljs !== 'undefined') {
                    markdownContent.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                }
            }
            
            // Extract model information from response if available
            const modelMeta = messageElement.querySelector('[data-model]');
            const modelName = modelMeta ? modelMeta.dataset.model : 
                             (messageElement.querySelector('.message-meta')?.textContent?.split('‚Ä¢')[0]?.trim() || 'Unknown');
            
            // Extract trace_id from data attribute if not in headers
            const traceIdFromData = messageElement.querySelector('[data-trace-id]')?.dataset.traceId || null;
            const finalTraceId = traceId || traceIdFromData;
            
            const responseText = messageElement.querySelector('.message-content')?.textContent || 
                                messageElement.querySelector('.message-content')?.innerText || '';
            
            // Extract duration if available
            const metaText = messageElement.querySelector('.message-meta')?.textContent || '';
            const durationMatch = metaText.match(/([\d.]+)s/);
            const duration = durationMatch ? durationMatch[1] : null;
            
            // Extract trace_id from meta text if available
            const traceMatch = metaText.match(/–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞:\s*([^\s‚Ä¢]+)/);
            const traceIdFromMeta = traceMatch ? traceMatch[1] : null;
            const actualTraceId = finalTraceId || traceIdFromMeta;
            
            // Add response log
            const logMetadata = {
                'Length': responseText.length,
                'Characters': responseText.length
            };
            if (duration) {
                logMetadata['Duration'] = `${duration}s`;
            }
            if (actualTraceId) {
                logMetadata['–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞'] = actualTraceId;
            }
            addModelLog('response', modelName, responseText.substring(0, 5000), logMetadata);
            
            // Update request log with trace_id if available
            if (actualTraceId) {
                const requestLogs = document.querySelectorAll('.log-entry[data-log-id]');
                if (requestLogs.length > 0) {
                    // Find the last request log
                    let lastRequestLog = null;
                    for (let i = requestLogs.length - 1; i >= 0; i--) {
                        const logEntry = requestLogs[i];
                        const typeSpan = logEntry.querySelector('.log-entry-type');
                        if (typeSpan && typeSpan.textContent === 'request') {
                            lastRequestLog = logEntry;
                            break;
                        }
                    }
                    
                    if (lastRequestLog) {
                        const metadataDiv = lastRequestLog.querySelector('.log-entry-metadata');
                        if (metadataDiv) {
                            // Find existing trace span or create new one
                            let traceSpan = null;
                            const spans = metadataDiv.querySelectorAll('span');
                            for (let span of spans) {
                                if (span.textContent.includes('–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞')) {
                                    traceSpan = span;
                                    break;
                                }
                            }
                            
                            if (traceSpan) {
                                traceSpan.innerHTML = `<strong>–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞:</strong> ${escapeHtml(actualTraceId)}`;
                            } else {
                                metadataDiv.innerHTML += ` <span><strong>–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞:</strong> ${escapeHtml(actualTraceId)}</span>`;
                            }
                            
                            // Also update the log entry in memory
                            const logId = lastRequestLog.dataset.logId;
                            const logEntry = modelLogs.find(log => log.id == logId);
                            if (logEntry && logEntry.metadata) {
                                logEntry.metadata['–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞'] = actualTraceId;
                                // Re-render the log entry to show updated trace_id
                                const logContainer = lastRequestLog.parentElement;
                                if (logContainer) {
                                    lastRequestLog.remove();
                                    renderModelLog(logEntry, logContainer.id || 'current-session-logs');
                                }
                                // Save updated logs to storage
                                saveModelLogsToStorage();
                            }
                        }
                    }
                }
            }
            
            scrollToBottom();
        })
        .catch(error => {
            if (error.name === 'AbortError') {
                console.log('Request cancelled by user');
                const messagesDiv = document.getElementById('messages');
                const cancelDiv = document.createElement('div');
                cancelDiv.className = 'message assistant';
                cancelDiv.innerHTML = `
                    <div class="message-content">
                        [–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º]
                    </div>
                    <div class="message-meta">–°–∏—Å—Ç–µ–º–∞</div>
                `;
                messagesDiv.appendChild(cancelDiv);
            } else {
                console.error('Error:', error);
                
                // Add error log
                addModelLog('error', 'System', error.message, {
                    'Error Type': error.name || 'Unknown',
                    'Status': error.status || 'Unknown'
                });
                
                const messagesDiv = document.getElementById('messages');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message assistant';
                errorDiv.innerHTML = `
                    <div class="message-content">
                        –û—à–∏–±–∫–∞: ${error.message}
                    </div>
                    <div class="message-meta">–°–∏—Å—Ç–µ–º–∞</div>
                `;
                messagesDiv.appendChild(errorDiv);
            }
        })
        .finally(() => {
            document.getElementById('loading').classList.remove('show');
            document.getElementById('submit-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            currentGenerationAbortController = null;
            // Clear input
            document.getElementById('message-input').value = '';
            autoResizeTextarea();
        });
        
        return false;
    }

    // Scroll to bottom
    function scrollToBottom() {
        const messagesDiv = document.getElementById('messages');
        if (messagesDiv) {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    }

    // Stop generation
    function stopGeneration() {
        if (currentGenerationAbortController) {
            currentGenerationAbortController.abort();
            currentGenerationAbortController = null;
        }
        
        // Also call backend cancel endpoint
        fetch('/api/chat/cancel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        }).catch(err => console.error('Error cancelling:', err));
        
        document.getElementById('stop-btn').disabled = true;
        document.getElementById('submit-btn').disabled = false;
        document.getElementById('loading').classList.remove('show');
    }
    
    // Model Logs Functions
    let modelLogs = [];
    let modelLogsEnabled = true;
    
    function addModelLog(type, model, content, metadata = {}) {
        if (!modelLogsEnabled) return;
        
        const logEntry = {
            id: Date.now() + Math.random(),
            type: type, // 'request', 'response', 'thinking', 'error'
            model: model || 'Unknown',
            content: content,
            metadata: metadata,
            timestamp: new Date().toISOString()
        };
        
        modelLogs.push(logEntry);
        
        // Save to localStorage
        saveModelLogsToStorage();
        
        // Hide empty state
        const emptyState = document.getElementById('empty-logs-state');
        if (emptyState) emptyState.style.display = 'none';
        
        // Render in current session logs container
        renderModelLog(logEntry, 'current-session-logs');
        
        // Auto-scroll if enabled
        const autoScroll = document.getElementById('auto-scroll-logs')?.checked;
        if (autoScroll) {
            const logsContent = document.getElementById('model-logs-content');
            if (logsContent) {
                logsContent.scrollTop = logsContent.scrollHeight;
            }
        }
    }
    
    function renderModelLog(logEntry, containerId = 'model-logs-content') {
        const container = containerId === 'model-logs-content' 
            ? document.getElementById('model-logs-content')
            : document.getElementById(containerId);
        if (!container) return;
        
        // Hide empty state if present
        const emptyState = document.getElementById('empty-logs-state');
        if (emptyState) {
            emptyState.style.display = 'none';
        }
        
        // Check filters
        const showRequests = document.getElementById('show-requests')?.checked ?? true;
        const showResponses = document.getElementById('show-responses')?.checked ?? true;
        const showThinking = document.getElementById('show-thinking')?.checked ?? true;
        
        if (logEntry.type === 'request' && !showRequests) return;
        if (logEntry.type === 'response' && !showResponses) return;
        if (logEntry.type === 'thinking' && !showThinking) return;
        
        const logDiv = document.createElement('div');
        logDiv.className = 'log-entry';
        logDiv.dataset.logId = logEntry.id;
        
        const timeStr = new Date(logEntry.timestamp).toLocaleTimeString('ru-RU');
        
        let contentDisplay = '';
        if (typeof logEntry.content === 'object') {
            contentDisplay = `<div class="json-view">${JSON.stringify(logEntry.content, null, 2)}</div>`;
        } else {
            contentDisplay = `<pre>${escapeHtml(String(logEntry.content))}</pre>`;
        }
        
        logDiv.innerHTML = `
            <div class="log-entry-header">
                <div>
                    <span class="log-entry-model">${escapeHtml(logEntry.model)}</span>
                    <span class="log-entry-type ${logEntry.type}">${logEntry.type}</span>
                </div>
                <span class="log-entry-time">${timeStr}</span>
            </div>
            <div class="log-entry-content">
                ${contentDisplay}
            </div>
            ${Object.keys(logEntry.metadata).length > 0 ? `
                <div class="log-entry-metadata">
                    ${Object.entries(logEntry.metadata).map(([key, value]) => 
                        `<span><strong>${escapeHtml(key)}:</strong> ${escapeHtml(String(value))}</span>`
                    ).join('')}
                </div>
            ` : ''}
        `;
        
        container.appendChild(logDiv);
    }
    
    function clearModelLogs() {
        if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ª–æ–≥–∏ –º–æ–¥–µ–ª–µ–π?')) {
            modelLogs = [];
            localStorage.removeItem('aard_model_logs');
            
            const currentLogsContainer = document.getElementById('current-session-logs');
            const summaryContainer = document.getElementById('summary-container');
            
            if (currentLogsContainer) {
                currentLogsContainer.innerHTML = '';
            }
            if (summaryContainer) {
                summaryContainer.innerHTML = '';
            }
            
            const emptyState = document.getElementById('empty-logs-state');
            if (emptyState) {
                emptyState.style.display = 'block';
            }
        }
    }
    
    function saveModelLogsToStorage() {
        try {
            localStorage.setItem('aard_model_logs', JSON.stringify(modelLogs));
        } catch (e) {
            console.warn('Failed to save model logs to localStorage:', e);
        }
    }
    
    function loadModelLogsFromStorage() {
        try {
            const saved = localStorage.getItem('aard_model_logs');
            if (saved) {
                modelLogs = JSON.parse(saved);
                
                // Render all saved logs
                const currentLogsContainer = document.getElementById('current-session-logs');
                if (currentLogsContainer && modelLogs.length > 0) {
                    const emptyState = document.getElementById('empty-logs-state');
                    if (emptyState) {
                        emptyState.style.display = 'none';
                    }
                    
                    currentLogsContainer.innerHTML = '';
                    modelLogs.forEach(log => {
                        renderModelLog(log, 'current-session-logs');
                    });
                }
            }
        } catch (e) {
            console.warn('Failed to load model logs from localStorage:', e);
            modelLogs = [];
        }
    }
    
    // Load model logs from API (from Digital Twin context)
    async function loadModelLogsFromAPI(taskId = null) {
        try {
            let url = '/api/model-logs/latest?limit=100';
            if (taskId) {
                url = `/api/model-logs/task/${taskId}`;
            }
            
            const response = await fetch(url);
            if (!response.ok) {
                console.error('Failed to load model logs:', response.statusText);
                return;
            }
            
            const data = await response.json();
            
            if (data.logs && data.logs.length > 0) {
                // Replace all logs (no real-time updates - manual refresh only)
                // Clear existing logs first
                modelLogs = [];
                const logsContent = document.getElementById('model-logs-content');
                if (logsContent) {
                    logsContent.innerHTML = '';
                }
                
                // Remove empty state if present
                const wasEmpty = logsContent && logsContent.querySelector('.empty-logs');
                if (wasEmpty) {
                    wasEmpty.remove();
                }
                
                let newLogsCount = 0;
                
                // Add all logs from API
                data.logs.forEach(log => {
                    const logEntry = {
                        id: Date.now() + Math.random() + newLogsCount,
                        type: log.type,
                        model: log.model,
                        content: log.content,
                        metadata: log.metadata || {},
                        timestamp: log.timestamp,
                        stage: log.stage || null
                    };
                    modelLogs.push(logEntry);
                    renderModelLog(logEntry);
                    newLogsCount++;
                });
                
                // Sort by timestamp (oldest first for chronological view)
                modelLogs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                // Re-render all logs in sorted order
                if (logsContent && modelLogs.length > 0) {
                    logsContent.innerHTML = '';
                    modelLogs.forEach(log => renderModelLog(log));
                }
                
                // Auto-scroll to new logs if enabled
                if (newLogsCount > 0) {
                    const autoScroll = document.getElementById('auto-scroll-logs')?.checked;
                    if (autoScroll && logsContent) {
                        setTimeout(() => {
                            logsContent.scrollTop = logsContent.scrollHeight;
                        }, 100);
                    }
                }
                
                if (newLogsCount > 0) {
                    console.log(`‚úÖ Added ${newLogsCount} new logs (total: ${modelLogs.length})`);
                }
            } else {
                console.log('No model logs found in API');
            }
        } catch (error) {
            console.error('Error loading model logs:', error);
        }
    }
    
    // Setup filter listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Re-render logs when filters change
        ['show-requests', 'show-responses', 'show-thinking'].forEach(filterId => {
            const filter = document.getElementById(filterId);
            if (filter) {
                filter.addEventListener('change', function() {
                    const logsContent = document.getElementById('model-logs-content');
                    if (logsContent && modelLogs.length > 0) {
                        // Remove empty state
                        const emptyState = logsContent.querySelector('.empty-logs');
                        if (emptyState) emptyState.remove();
                        
                        // Clear and re-render all logs
                        logsContent.innerHTML = '';
                        modelLogs.forEach(log => renderModelLog(log));
                    }
                });
            }
        });
        
        // Real-time refresh for current work (every 1 second when tab is active)
        let currentWorkRefreshInterval = null;
        
        function startCurrentWorkRefresh() {
            if (currentWorkRefreshInterval) return; // Already running
            
            // Load immediately first time
            loadCurrentWork();
            
            currentWorkRefreshInterval = setInterval(function() {
                const currentWorkTab = document.getElementById('current-work-tab');
                if (currentWorkTab && currentWorkTab.classList.contains('active')) {
                    loadCurrentWork();
                } else {
                    // Tab is no longer active, stop refresh
                    stopCurrentWorkRefresh();
                }
            }, 1000); // Refresh every 1 second for real-time updates
            console.log('üîÑ Real-time current work refresh started (1s interval)');
        }
        
        function stopCurrentWorkRefresh() {
            if (currentWorkRefreshInterval) {
                clearInterval(currentWorkRefreshInterval);
                currentWorkRefreshInterval = null;
                console.log('‚è∏Ô∏è Real-time current work refresh stopped');
            }
        }
        
        // Make functions globally available for switchTab to use
        window.startCurrentWorkRefresh = startCurrentWorkRefresh;
        window.stopCurrentWorkRefresh = stopCurrentWorkRefresh;
    });
    
    // Load model logs summary with branching information
    async function loadModelLogsSummary() {
        try {
            const response = await fetch('/api/model-logs/summaries/latest?limit=10');
            if (!response.ok) {
                console.error('Failed to load model logs summary:', response.statusText);
                return;
            }
            
            const data = await response.json();
            
            // Render summaries in summary container (don't replace current logs)
            const summaryContainer = document.getElementById('summary-container');
            if (!summaryContainer) return;
            
            // Clear only summary container
            summaryContainer.innerHTML = '';
            
            // Hide empty state if summaries exist
            const emptyState = document.getElementById('empty-logs-state');
            
            if (!data.summaries || data.summaries.length === 0) {
                if (emptyState) {
                    emptyState.style.display = 'block';
                }
                return;
            }
            
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Render summaries
            data.summaries.forEach(summary => {
                const summaryHtml = renderTaskSummary(summary);
                const summaryDiv = document.createElement('div');
                summaryDiv.innerHTML = summaryHtml;
                summaryContainer.appendChild(summaryDiv.firstElementChild);
            });
        } catch (error) {
            console.error('Error loading model logs summary:', error);
        }
    }
    
    // Render task summary with all branches
    function renderTaskSummary(summary) {
        let html = `
            <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                    <div>
                        <h3 style="margin: 0 0 8px 0; font-size: 18px;">${escapeHtml(summary.task_description)}</h3>
                        <div style="display: flex; gap: 12px; font-size: 13px; color: #6c757d; flex-wrap: wrap;">
                            <span>–°—Ç–∞—Ç—É—Å: <strong>${summary.status}</strong></span>
                            <span>ID: ${summary.task_id.substring(0, 8)}...</span>
                            ${summary.trace_id ? `<span><strong>–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞:</strong> ${summary.trace_id}</span>` : ''}
                        </div>
                    </div>
                </div>
                
                <div style="border-top: 1px solid #e9ecef; padding-top: 16px;">
        `;
        
        // User request
        if (summary.user_request) {
            html += `
                <div style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">üìù –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</h4>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; font-size: 14px;">
                        ${escapeHtml(summary.user_request)}
                    </div>
                </div>
            `;
        }
        
        // Plans branching
        if (summary.plans && summary.plans.length > 0) {
            html += `
                <div style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">üìã –ü–ª–∞–Ω—ã (${summary.plans.length} –≤–µ—Ä—Å–∏–π):</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
            `;
            summary.plans.forEach(plan => {
                html += `
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 3px solid ${plan.version === summary.plans[summary.plans.length - 1].version ? '#2563eb' : '#ccc'};">
                        <div style="font-weight: 600;">–í–µ—Ä—Å–∏—è ${plan.version} ${plan.version === summary.plans[summary.plans.length - 1].version ? '(—Ç–µ–∫—É—â–∞—è)' : ''}</div>
                        <div style="font-size: 13px; color: #6c757d; margin-top: 4px;">
                            –°—Ç–∞—Ç—É—Å: ${plan.status} | –®–∞–≥–æ–≤: ${plan.steps_count}
                        </div>
                    </div>
                `;
            });
            html += '</div></div>';
        }
        
        // Replanning history
        if (summary.replanning_history && summary.replanning_history.length > 0) {
            html += `
                <div style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">üîÑ –ò—Å—Ç–æ—Ä–∏—è —Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
            `;
            summary.replanning_history.forEach(replan => {
                html += `
                    <div style="background: #fff3cd; padding: 12px; border-radius: 6px; font-size: 13px;">
                        <strong>v${replan.from_version} ‚Üí v${replan.to_version}:</strong> ${escapeHtml(replan.reason || '–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞')}
                    </div>
                `;
            });
            html += '</div></div>';
        }
        
        // What was done / not done
        if (summary.what_was_done && summary.what_was_done.length > 0) {
            html += `
                <div style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:</h4>
                    <ul style="margin: 0; padding-left: 20px; font-size: 13px;">
            `;
            summary.what_was_done.forEach(item => {
                html += `<li>${escapeHtml(item)}</li>`;
            });
            html += '</ul></div>';
        }
        
        if (summary.what_was_not_done && summary.what_was_not_done.length > 0) {
            html += `
                <div style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">‚ùå –ß—Ç–æ –Ω–µ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
            `;
            summary.what_was_not_done.forEach(item => {
                html += `
                    <div style="background: #f8d7da; padding: 12px; border-radius: 6px; font-size: 13px;">
                        <strong>${escapeHtml(item.step)}</strong><br>
                        <span style="color: #721c24;">–ü—Ä–∏—á–∏–Ω–∞: ${escapeHtml(item.reason || '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}</span>
                    </div>
                `;
            });
            html += '</div></div>';
        }
        
        html += '</div></div>';
        return html;
    }
    
    // Load current work (active tasks)
    async function loadCurrentWork() {
        try {
            const response = await fetch('/api/workflow/current');
            if (!response.ok) {
                console.error('Failed to load current workflow:', response.statusText);
                return;
            }
            
            const data = await response.json();
            const content = document.getElementById('current-work-content');
            const statusEl = document.getElementById('current-work-status');
            
            if (!content) return;
            
            // Remove empty state
            const emptyState = content.querySelector('.empty-logs');
            if (emptyState) emptyState.remove();
            
            if (!data.is_active && (!data.events || data.events.length === 0)) {
                content.innerHTML = `
                    <div class="empty-logs">
                        <div class="empty-logs-icon">‚öôÔ∏è</div>
                        <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</p>
                        <p style="font-size: 13px; margin-top: 8px;">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞–ø—Ä–æ—Å –≤ —á–∞—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</p>
                    </div>
                `;
                if (statusEl) statusEl.textContent = '';
                return;
            }
            
            if (statusEl) {
                const stageText = data.current_stage || '–æ–∂–∏–¥–∞–Ω–∏–µ';
                statusEl.textContent = data.is_active ? `üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (${stageText})` : `‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ`;
            }
            
            // Render workflow events
            renderWorkflowEvents(data.events || [], data.current_stage);
        } catch (error) {
            console.error('Error loading current workflow:', error);
        }
    }
    
    // Render workflow events
    function renderWorkflowEvents(events, currentStage) {
        const content = document.getElementById('current-work-content');
        if (!content) return;
        
        if (!events || events.length === 0) {
            content.innerHTML = `
                <div class="empty-logs">
                    <div class="empty-logs-icon">‚öôÔ∏è</div>
                    <p>–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                </div>
            `;
            return;
        }
        
        // Group events by stage
        const stageOrder = {
            'user_request': 1,
            'request_parsing': 2,
            'action_determination': 3,
            'execution': 4,
            'result': 5,
            'error': 6
        };
        
        const stageLabels = {
            'user_request': 'üìù –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
            'request_parsing': 'üîç –†–∞–∑–±–æ—Ä –∑–∞–ø—Ä–æ—Å–∞',
            'action_determination': '‚öôÔ∏è –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π',
            'execution': 'üöÄ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ',
            'result': '‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç',
            'error': '‚ùå –û—à–∏–±–∫–∞'
        };
        
        let html = '<div style="display: flex; flex-direction: column; gap: 16px;">';
        
        events.forEach((event, index) => {
            const stage = event.stage || 'execution';
            const isCurrent = currentStage === stage && index === events.length - 1;
            const stageLabel = stageLabels[stage] || '‚öôÔ∏è –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ';
            
            // Color based on stage
            let bgColor = '#f8f9fa';
            let borderColor = '#e9ecef';
            if (stage === 'user_request') {
                bgColor = '#e7f3ff';
                borderColor = '#b3d9ff';
            } else if (stage === 'request_parsing' || stage === 'action_determination') {
                bgColor = '#fff3cd';
                borderColor = '#ffc107';
            } else if (stage === 'execution') {
                bgColor = isCurrent ? '#d1ecf1' : '#f8f9fa';
                borderColor = isCurrent ? '#0dcaf0' : '#e9ecef';
            } else if (stage === 'result') {
                bgColor = '#d4edda';
                borderColor = '#28a745';
            } else if (stage === 'error') {
                bgColor = '#f8d7da';
                borderColor = '#dc3545';
            }
            
            const timestamp = new Date(event.timestamp).toLocaleTimeString();
            
            html += `
                <div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 6px; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div style="font-weight: 600; font-size: 14px; color: #495057;">
                            ${stageLabel} ${isCurrent ? '<span style="color: #0dcaf0;">‚óè</span>' : ''}
                        </div>
                        <div style="font-size: 12px; color: #6c757d;">
                            ${timestamp}
                        </div>
                    </div>
                    <div style="font-size: 14px; color: #212529; line-height: 1.6;">
                        ${escapeHtml(event.message)}
                        ${event.details && event.details.full_response ? `
                            <div style="margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #2563eb;">
                                <div style="font-weight: 600; margin-bottom: 8px; font-size: 13px;">–û—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏:</div>
                                <div style="font-size: 13px; color: #495057; white-space: pre-wrap; max-height: 300px; overflow-y: auto;">
                                    ${escapeHtml(event.details.full_response)}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    ${event.details && Object.keys(event.details).length > 0 && !event.details.full_response ? `
                        <div style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 4px; font-size: 12px; font-family: monospace; max-height: 200px; overflow-y: auto;">
                            ${JSON.stringify(event.details, null, 2)}
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        html += '</div>';
        content.innerHTML = html;
        
        // Don't auto-scroll - let user control scrolling manually
        // Auto-scroll was interfering with reading events
    }
    
    // Render active task with real-time progress (deprecated, kept for compatibility)
    function renderActiveTask(task) {
        const progressColor = task.progress_percent < 50 ? '#dc3545' : task.progress_percent < 80 ? '#ffc107' : '#28a745';
        
        let html = `
            <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 8px 0; font-size: 18px;">${escapeHtml(task.description)}</h3>
                        <div style="display: flex; gap: 12px; font-size: 13px; color: #6c757d;">
                            <span>–°—Ç–∞—Ç—É—Å: <strong>${task.status}</strong></span>
                            <span>–≠—Ç–∞–ø: <strong>${task.current_stage}</strong></span>
                            ${task.plan_version ? `<span>–ü–ª–∞–Ω v${task.plan_version}</span>` : ''}
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px;">
                        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                        <span style="font-weight: 600;">${task.completed_steps} / ${task.total_steps} —à–∞–≥–æ–≤ (${Math.round(task.progress_percent)}%)</span>
                    </div>
                    <div style="background: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: ${progressColor}; height: 100%; width: ${task.progress_percent}%; transition: width 0.3s;"></div>
                    </div>
                </div>
        `;
        
        // Current step
        if (task.current_step) {
            html += `
                <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">
                        –¢–µ–∫—É—â–∏–π —à–∞–≥ ${task.current_step.step_number}: ${escapeHtml(task.current_step.description)}
                    </div>
                    <div style="font-size: 13px; color: #6c757d;">
                        –°—Ç–∞—Ç—É—Å: ${task.current_step.status}
                    </div>
                </div>
            `;
        }
        
        // Latest logs
        if (task.latest_logs && task.latest_logs.length > 0) {
            html += `
                <div style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:</h4>
                    <div style="display: flex; flex-direction: column; gap: 4px; max-height: 200px; overflow-y: auto;">
            `;
            task.latest_logs.slice(-5).reverse().forEach(log => {
                html += `
                    <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-size: 12px;">
                        <span style="color: #6c757d;">[${new Date(log.timestamp).toLocaleTimeString()}]</span>
                        <span style="font-weight: 600;">${log.stage}:</span>
                        <span>${escapeHtml(log.content_preview || '')}</span>
                    </div>
                `;
            });
            html += '</div></div>';
        }
        
        html += '</div>';
        return html;
    }
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
</script>
{% endblock %}


{% extends "base.html" %}

{% block title %}{{ tool.name }} - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç{% endblock %}

{% block body_class %}iframe-page{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #f8f9fa;
        padding: 0;
        margin: 0;
        min-height: auto;
        display: block;
    }
    
    body.iframe-page {
        background: #f8f9fa;
        padding: 0;
        margin: 0;
        min-height: auto;
        display: block;
    }
    .card {
        border: 1px solid #dee2e6;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .metric-card {
        text-align: center;
        padding: 20px;
    }
    .metric-value {
        font-size: 32px;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 8px;
    }
    .metric-label {
        font-size: 14px;
        color: #6c757d;
    }
    .status-badge {
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
    }
    .code-block {
        background: #f4f4f4;
        padding: 15px;
        border-radius: 6px;
        overflow-x: auto;
        font-family: 'Courier New', monospace;
        font-size: 13px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>{{ tool.name }}</h1>
            <p class="text-muted mb-0">{{ tool.description or '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è' }}</p>
        </div>
        <div>
            <a href="/tools/{{ tool.id }}/edit" class="btn btn-outline-primary me-2">
                <i class="bi bi-pencil"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </a>
            <a href="/tools" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
            </a>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å –∏ –æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>–°—Ç–∞—Ç—É—Å:</strong>
                            {% if tool.status == 'active' %}
                                <span class="status-badge bg-success text-white ms-2">–ê–∫—Ç–∏–≤–µ–Ω</span>
                            {% elif tool.status == 'draft' %}
                                <span class="status-badge bg-warning text-dark ms-2">–ß–µ—Ä–Ω–æ–≤–∏–∫</span>
                            {% elif tool.status == 'waiting_approval' %}
                                <span class="status-badge bg-info text-white ms-2">–û–∂–∏–¥–∞–µ—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</span>
                            {% elif tool.status == 'deprecated' %}
                                <span class="status-badge bg-dark text-white ms-2">–£—Å—Ç–∞—Ä–µ–ª</span>
                            {% elif tool.status == 'failed' %}
                                <span class="status-badge bg-danger text-white ms-2">–û—à–∏–±–∫–∞</span>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>–¢–∏–ø:</strong> <span class="ms-2">{{ tool.tool_type }}</span>
                        </div>
                    </div>
                    
                    {% if tool.category %}
                    <div class="mb-3">
                        <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> <span class="ms-2">{{ tool.category }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞:</strong> <span class="ms-2">{{ tool.entry_point }}</span>
                        </div>
                        <div class="col-md-6">
                            <strong>–í–µ—Ä—Å–∏—è:</strong> <span class="ms-2">v{{ tool.version }}</span>
                        </div>
                    </div>
                    
                    {% if tool.code %}
                    <div class="mb-3">
                        <strong>–ö–æ–¥:</strong>
                        <div class="code-block mt-2">{{ tool.code }}</div>
                    </div>
                    {% endif %}
                    
                    {% if tool.input_schema %}
                    <div class="mb-3">
                        <strong>–°—Ö–µ–º–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:</strong>
                        <div class="code-block mt-2">{{ tool.input_schema | tojson(indent=2) }}</div>
                    </div>
                    {% endif %}
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <strong>–°–æ–∑–¥–∞–Ω:</strong> 
                            <span class="ms-2">{{ tool.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                        <div class="col-md-6">
                            <strong>–û–±–Ω–æ–≤–ª–µ–Ω:</strong> 
                            <span class="ms-2">{{ tool.updated_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                    </div>
                    
                    {% if tool.last_used_at %}
                    <div class="mt-3">
                        <strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:</strong> 
                        <span class="ms-2">{{ tool.last_used_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- –ú–µ—Ç—Ä–∏–∫–∏ -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìä –ú–µ—Ç—Ä–∏–∫–∏</h5>
                </div>
                <div class="card-body">
                    <div class="metric-card">
                        <div class="metric-value">{{ metrics.total_executions }}</div>
                        <div class="metric-label">–í—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π</div>
                    </div>
                    <hr>
                    <div class="metric-card">
                        <div class="metric-value text-success">{{ metrics.successful_executions }}</div>
                        <div class="metric-label">–£—Å–ø–µ—à–Ω—ã—Ö</div>
                    </div>
                    <hr>
                    <div class="metric-card">
                        <div class="metric-value text-danger">{{ metrics.failed_executions }}</div>
                        <div class="metric-label">–ù–µ—É–¥–∞—á–Ω—ã—Ö</div>
                    </div>
                    <hr>
                    <div class="metric-card">
                        <div class="metric-value">{{ metrics.success_rate }}</div>
                        <div class="metric-label">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</div>
                    </div>
                    {% if metrics.average_execution_time %}
                    <hr>
                    <div class="metric-card">
                        <div class="metric-value">{{ (metrics.average_execution_time / 1000)|round(1) }}s</div>
                        <div class="metric-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">‚öôÔ∏è –î–µ–π—Å—Ç–≤–∏—è</h5>
                </div>
                <div class="card-body">
                    <div class="btn-group" role="group">
                        {% if tool.status == 'draft' or tool.status == 'deprecated' or tool.status == 'failed' %}
                        <button type="button" class="btn btn-success" onclick="activateTool('{{ tool.id }}')">
                            <i class="bi bi-play-circle"></i> –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        {% endif %}
                        {% if tool.status == 'active' %}
                        <button type="button" class="btn btn-warning" onclick="deactivateTool('{{ tool.id }}')">
                            <i class="bi bi-pause-circle"></i> –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        {% endif %}
                        <button type="button" class="btn btn-danger" onclick="deleteTool('{{ tool.id }}')">
                            <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function activateTool(toolId) {
    if (!confirm('–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç?')) return;
    
    try {
        const response = await fetch(`/api/tools/${toolId}/activate`, {
            method: 'POST'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert('–û—à–∏–±–∫–∞: ' + (data.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç'));
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
}

async function deactivateTool(toolId) {
    if (!confirm('–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç?')) return;
    
    try {
        const response = await fetch(`/api/tools/${toolId}/deactivate`, {
            method: 'POST'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert('–û—à–∏–±–∫–∞: ' + (data.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç'));
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
}

async function deleteTool(toolId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
    
    try {
        const response = await fetch(`/api/tools/${toolId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            window.location.href = '/tools';
        } else {
            const data = await response.json();
            alert('–û—à–∏–±–∫–∞: ' + (data.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç'));
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
}
</script>
{% endblock %}


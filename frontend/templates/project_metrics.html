{% extends "base.html" %}

{% block title %}–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ - AARD{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    body {
        background-color: #f8f9fa;
    }
    .card {
        border: 1px solid #dee2e6;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
    }
    .metric-card {
        text-align: center;
        padding: 20px;
    }
    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #667eea;
    }
    .metric-label {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 8px;
    }
    .metric-change {
        font-size: 0.85rem;
        margin-top: 4px;
    }
    .metric-change.positive {
        color: #28a745;
    }
    .metric-change.negative {
        color: #dc3545;
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 20px;
    }
    .period-selector {
        margin-bottom: 20px;
    }
    .trend-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 8px;
    }
    .trend-improving {
        background-color: #d4edda;
        color: #155724;
    }
    .trend-degrading {
        background-color: #f8d7da;
        color: #721c24;
    }
    .trend-stable {
        background-color: #d1ecf1;
        color: #0c5460;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üìä –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞</h1>
        <div class="period-selector">
            <select id="periodSelect" class="form-select form-select-sm" onchange="loadMetrics()">
                <option value="7">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                <option value="30" selected>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                <option value="90">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π</option>
                <option value="365">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥</option>
            </select>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card metric-card">
                <div class="metric-value" id="successRateValue">
                    {{ "%.1f"|format(overview.performance.success_rate * 100) if overview.performance.success_rate else "N/A" }}%
                </div>
                <div class="metric-label">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á</div>
                <div class="metric-change" id="successRateChange"></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card">
                <div class="metric-value" id="executionTimeValue">
                    {{ "%.2f"|format(overview.performance.avg_execution_time) if overview.performance.avg_execution_time else "N/A" }}s
                </div>
                <div class="metric-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</div>
                <div class="metric-change" id="executionTimeChange"></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card">
                <div class="metric-value" id="totalTasksValue">
                    {{ overview.performance.total_tasks if overview.performance.total_tasks else 0 }}
                </div>
                <div class="metric-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
                <div class="metric-change" id="totalTasksChange"></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card">
                <div class="metric-value" id="totalPlansValue">
                    {{ overview.plans.total if overview.plans.total else 0 }}
                </div>
                <div class="metric-label">–í—Å–µ–≥–æ –ø–ª–∞–Ω–æ–≤</div>
                <div class="metric-change" id="totalPlansChange"></div>
            </div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤ -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–¢—Ä–µ–Ω–¥ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞—á</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="successRateChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–¢—Ä–µ–Ω–¥ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="executionTimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="statusDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="plansChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ù–µ–¥–∞–≤–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–ù–µ–¥–∞–≤–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>–¢–∏–ø –º–µ—Ç—Ä–∏–∫–∏</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                    <th>–ü–µ—Ä–∏–æ–¥</th>
                                    <th>–î–∞—Ç–∞</th>
                                </tr>
                            </thead>
                            <tbody id="recentMetricsTable">
                                {% if overview.recent_metrics %}
                                {% for metric in overview.recent_metrics[:20] %}
                                <tr>
                                    <td>{{ metric.get('metric_type', 'N/A') }}</td>
                                    <td>{{ metric.get('metric_name', 'N/A') }}</td>
                                    <td>{% if metric.get('value') %}{{ "%.2f"|format(metric.value) }}{% else %}N/A{% endif %}</td>
                                    <td>{{ metric.get('count', 0) }}</td>
                                    <td>{{ metric.get('period', 'N/A') }}</td>
                                    <td>{% if metric.get('period_start') %}{{ metric.period_start[:10] }}{% else %}N/A{% endif %}</td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Chart.js configuration
Chart.defaults.responsive = true;
Chart.defaults.maintainAspectRatio = false;

// Prepare data for charts
const successRateData = {
    labels: {{ success_rate_trends|map(attribute='period_start')|map('truncate', 10, True, '')|list|tojson }},
    values: {{ success_rate_trends|map(attribute='value')|list|tojson }}
};

const executionTimeData = {
    labels: {{ execution_time_trends|map(attribute='period_start')|map('truncate', 10, True, '')|list|tojson }},
    values: {{ execution_time_trends|map(attribute='value')|list|tojson }}
};

const statusDistribution = {{ overview.distribution.by_status|tojson }};
const plansData = {
    total: {{ overview.plans.total }},
    completed: {{ overview.plans.completed }},
    failed: {{ overview.plans.failed }}
};

// Success Rate Chart
const successRateCtx = document.getElementById('successRateChart').getContext('2d');
const successRateChart = new Chart(successRateCtx, {
    type: 'line',
    data: {
        labels: successRateData.labels,
        datasets: [{
            label: '–£—Å–ø–µ—à–Ω–æ—Å—Ç—å (%)',
            data: successRateData.values.map(v => v ? (v * 100) : 0),
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        }
    }
});

// Execution Time Chart
const executionTimeCtx = document.getElementById('executionTimeChart').getContext('2d');
const executionTimeChart = new Chart(executionTimeCtx, {
    type: 'line',
    data: {
        labels: executionTimeData.labels,
        datasets: [{
            label: '–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (—Å–µ–∫)',
            data: executionTimeData.values.map(v => v || 0),
            borderColor: '#764ba2',
            backgroundColor: 'rgba(118, 75, 162, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value + 's';
                    }
                }
            }
        }
    }
});

// Status Distribution Chart
const statusCtx = document.getElementById('statusDistributionChart').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: statusDistribution.map(s => s.status || 'Unknown'),
        datasets: [{
            data: statusDistribution.map(s => s.count || 0),
            backgroundColor: [
                '#28a745', '#0d6efd', '#ffc107', '#dc3545', '#6c757d'
            ]
        }]
    }
});

// Plans Chart
const plansCtx = document.getElementById('plansChart').getContext('2d');
const plansChart = new Chart(plansCtx, {
    type: 'bar',
    data: {
        labels: ['–í—Å–µ–≥–æ', '–ó–∞–≤–µ—Ä—à–µ–Ω–æ', '–ü—Ä–æ–≤–∞–ª–µ–Ω–æ'],
        datasets: [{
            label: '–ü–ª–∞–Ω—ã',
            data: [
                plansData.total || 0,
                plansData.completed || 0,
                plansData.failed || 0
            ],
            backgroundColor: ['#667eea', '#28a745', '#dc3545']
        }]
    },
    options: {
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Load metrics for selected period
async function loadMetrics() {
    const days = document.getElementById('periodSelect').value;
    try {
        const response = await fetch(`/api/metrics/project/overview?days=${days}`);
        const data = await response.json();
        
        // Update metric values
        document.getElementById('successRateValue').textContent = 
            (data.performance.success_rate * 100).toFixed(1) + '%';
        document.getElementById('executionTimeValue').textContent = 
            data.performance.avg_execution_time.toFixed(2) + 's';
        document.getElementById('totalTasksValue').textContent = 
            data.performance.total_tasks;
        document.getElementById('totalPlansValue').textContent = 
            data.plans.total;
        
        // Reload page to update charts
        window.location.reload();
    } catch (error) {
        console.error('Error loading metrics:', error);
    }
}
</script>
{% endblock %}


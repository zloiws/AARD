# Защита базы данных от случайного обнуления

## ⚠️ ВАЖНО: Защита от случайного удаления данных

Все скрипты, которые могут удалить или изменить данные в базе, теперь защищены дополнительными проверками.

## Защищенные скрипты

### 1. `clear_database.py`
**Что делает:** Очищает все данные из таблиц (TRUNCATE)

**Защита:**
- ✅ Проверка окружения (запрещено в production)
- ✅ Двойное подтверждение:
  1. Нужно ввести `DELETE ALL DATA` (точно)
  2. Нужно ввести `YES` (точно)
- ✅ Логирование операции
- ✅ Восстановление только по запросу (нужно ввести `RESTORE`)

**Использование:**
```bash
# Интерактивный режим (рекомендуется)
python backend/scripts/clear_database.py

# С флагом --yes (все равно требует подтверждения)
python backend/scripts/clear_database.py --yes
```

### 2. `restore_after_clear.py`
**Что делает:** Восстанавливает таблицы и данные после очистки

**Защита:**
- ✅ Требует подтверждения `CREATE TABLES` перед созданием таблиц
- ✅ Не вызывается автоматически

**Использование:**
```bash
python backend/scripts/restore_after_clear.py
```

### 3. `apply_all_migrations.py`
**Что делает:** Сбрасывает состояние миграций и применяет все заново

**Защита:**
- ✅ Требует подтверждения `RESET MIGRATIONS`
- ✅ Предупреждение о последствиях

**Использование:**
```bash
python apply_all_migrations.py
```

## Что НЕ удаляет таблицы

- ✅ `clear_database.py` - только очищает данные (TRUNCATE), не удаляет таблицы
- ✅ Миграции Alembic - только создают/изменяют структуру, не удаляют данные
- ✅ Тесты - используют отдельную тестовую БД

## Что МОЖЕТ удалить таблицы

- ⚠️ `alembic downgrade base` - откатывает все миграции (удаляет таблицы)
- ⚠️ `Base.metadata.drop_all()` - удаляет все таблицы (используется только в тестах)
- ⚠️ Ручной SQL `DROP TABLE` - удаляет таблицы напрямую

## Рекомендации

1. **Никогда не запускайте скрипты очистки без необходимости**
2. **Всегда делайте бэкап перед очисткой**
3. **Используйте интерактивный режим для подтверждения**
4. **Проверяйте окружение (production защищен)**

## Автоматический запуск

**Все скрипты очистки НЕ запускаются автоматически:**
- ❌ Не вызываются из `main.py`
- ❌ Не вызываются из сервисов
- ❌ Не вызываются при старте приложения
- ✅ Только ручной запуск через командную строку

## Логирование

Все операции очистки логируются:
- Время операции
- Пользователь (если доступно)
- Подтверждения
- Результат операции

## Восстановление после очистки

Если база была очищена:
1. Запустите `restore_after_clear.py` для восстановления таблиц
2. Или примените миграции: `python apply_migrations.py`
3. Восстановите данные из бэкапа (если есть)


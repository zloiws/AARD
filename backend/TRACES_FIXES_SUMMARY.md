# Исправления трассировок - Резюме

## Проблемы, которые были исправлены

### 1. Ошибка UUID при поиске трассировок

**Проблема:**
```
invalid input syntax for type uuid: "2"
WHERE execution_traces.task_id = '2'::UUID
```

**Причина:**
В `backend/app/api/routes/traces_pages.py` параметр `task_id` использовался напрямую без преобразования в UUID, что вызывало ошибку при передаче обычного числа (например, "2").

**Исправление:**
- Добавлена проверка и преобразование строки в UUID перед использованием в запросе
- Добавлена обработка ошибок с возвратом HTTP 400 для невалидных UUID
- Исправлено в двух местах: основной запрос и статистический запрос

**Файлы:**
- `backend/app/api/routes/traces_pages.py` (строки 41-50, 61-70)

### 2. Избыточное сохранение SQLAlchemy spans

**Проблема:**
Все автоматически инструментированные SQLAlchemy запросы сохранялись в БД, даже если они:
- Были быстрыми (<100ms)
- Не содержали ошибок
- Не имели бизнес-контекста (task_id, plan_id, agent_id, tool_id)

Это приводило к накоплению большого количества бесполезных трассировок (44264+ записей).

**Решение:**
Добавлена фильтрация в `DatabaseSpanExporter._export_span()`:
- **Пропускаются** SQLAlchemy spans, которые:
  - Не содержат ошибок
  - Быстрые (<100ms)
  - Не имеют бизнес-контекста
  
- **Сохраняются** SQLAlchemy spans, которые:
  - Содержат ошибки (важно для отладки)
  - Медленные (>100ms) - проблемы производительности
  - Имеют бизнес-контекст (task_id, plan_id, agent_id, tool_id)

**Файлы:**
- `backend/app/core/trace_exporter.py` (строки 87-120)

## Результаты тестирования

✅ **UUID Conversion**: Корректная обработка валидных и невалидных UUID
✅ **Trace Filtering Logic**: Логика фильтрации SQLAlchemy spans присутствует
✅ **Traces API**: API работает корректно с UUID
✅ **Trace Exporter Filtering**: Все условия фильтрации реализованы

## Преимущества

1. **Меньше шума в БД**: Сохраняются только полезные трассировки
2. **Лучшая производительность**: Меньше записей = быстрее запросы
3. **Фокус на важном**: Сохраняются ошибки, медленные запросы и операции с бизнес-контекстом
4. **Корректная работа API**: Нет ошибок при поиске по UUID

## Рекомендации

1. **Мониторинг**: Следить за количеством сохраняемых трассировок после внедрения фильтрации
2. **Настройка порога**: При необходимости можно изменить порог времени (100ms) в `trace_exporter.py`
3. **Дополнительная фильтрация**: При необходимости можно добавить фильтрацию по другим критериям (например, по типу запроса)


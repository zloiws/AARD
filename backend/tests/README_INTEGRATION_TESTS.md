# Интеграционные тесты с реальными LLM

## Описание

Набор интеграционных тестов для проверки работы системы в боевом режиме с использованием реальных LLM через Ollama.

## Структура тестов

### 1. `test_integration_simple_question.py` - Простые вопросы
- **Тест 1**: Базовый простой вопрос (2+2)
- **Тест 2**: Приветствие
- **Тест 3**: Фактический вопрос (столица Франции)
- **Тест 4**: Вопрос с объяснением
- **Тест 5**: Проверка интеграции PromptManager

**Время выполнения**: ~30-60 секунд

### 2. `test_integration_code_generation.py` - Генерация кода
- **Тест 1**: Простая генерация функции
- **Тест 2**: Генерация кода с планированием
- **Тест 3**: Проверка метрик промптов
- **Тест 4**: Только планирование (без выполнения)

**Время выполнения**: ~2-5 минут

### 3. `test_integration_complex_task.py` - Сложные задачи
- **Тест 1**: Многошаговая задача
- **Тест 2**: Сложная задача с контекстом
- **Тест 3**: Полный workflow с отслеживанием промптов
- **Тест 4**: Обработка ошибок и fallback

**Время выполнения**: ~5-15 минут

### 4. `test_integration_prompt_improvement.py` - Улучшение промптов
- **Тест 1**: Отслеживание использования промптов
- **Тест 2**: Анализ и улучшение промптов
- **Тест 3**: A/B тестирование версий промптов
- **Тест 4**: Агрегация метрик промптов

**Время выполнения**: ~5-10 минут

## Требования

1. **Ollama сервер должен быть запущен** и доступен
2. **В базе данных должны быть настроены**:
   - Ollama серверы
   - Модели LLM
   - Активные промпты (опционально, есть fallback)
3. **База данных должна быть доступна** и настроена

## Запуск тестов

### Запуск всех интеграционных тестов

```bash
cd backend
pytest tests/test_integration_*.py -v -m integration
```

### Запуск только простых тестов (быстрые)

```bash
pytest tests/test_integration_simple_question.py -v
```

### Запуск тестов генерации кода

```bash
pytest tests/test_integration_code_generation.py -v
```

### Запуск сложных тестов (медленные)

```bash
pytest tests/test_integration_complex_task.py -v -m slow
```

### Запуск тестов улучшения промптов

```bash
pytest tests/test_integration_prompt_improvement.py -v -m slow
```

### Запуск конкретного теста

```bash
pytest tests/test_integration_simple_question.py::test_simple_question_basic -v
```

### Запуск с подробным выводом

```bash
pytest tests/test_integration_*.py -v -s --log-cli-level=INFO
```

## Проверка перед запуском

1. **Проверить Ollama сервер**:
   ```bash
   curl http://localhost:11434/api/tags
   ```

2. **Проверить базу данных**:
   ```bash
   # Убедиться, что есть активные серверы и модели
   python -c "from app.core.database import get_db; from app.services.ollama_service import OllamaService; db = next(get_db()); print(OllamaService.get_all_active_servers(db))"
   ```

3. **Проверить промпты** (опционально):
   ```bash
   # Промпты не обязательны, есть fallback на хардкод
   ```

## Ожидаемые результаты

### Успешный запуск

- Все тесты проходят
- В консоли виден вывод с результатами каждого теста
- Метрики промптов записываются
- Workflow отслеживается

### Возможные проблемы

1. **Нет доступных моделей**:
   - Ошибка: "No available models found"
   - Решение: Добавить модели в Ollama и зарегистрировать в БД

2. **Ollama сервер недоступен**:
   - Ошибка: Connection refused
   - Решение: Запустить Ollama сервер

3. **База данных недоступна**:
   - Ошибка: Database connection failed
   - Решение: Проверить настройки БД и запустить PostgreSQL

4. **Таймауты**:
   - Ошибка: TimeoutError
   - Решение: Увеличить timeout в pytest.ini или использовать более быстрые модели

## Интерпретация результатов

### Простые тесты (test_integration_simple_question.py)
- ✅ Все тесты проходят → Базовая функциональность работает
- ✅ PromptManager интегрирован → Система промптов работает

### Тесты генерации кода (test_integration_code_generation.py)
- ✅ Планирование работает → PlanningService интегрирован
- ✅ Метрики записываются → PromptManager работает корректно

### Сложные тесты (test_integration_complex_task.py)
- ✅ Полный workflow работает → Все компоненты интегрированы
- ✅ Fallback работает → Обработка ошибок корректна

### Тесты улучшения промптов (test_integration_prompt_improvement.py)
- ✅ Анализ работает → Автоматическое улучшение функционирует
- ✅ A/B тестирование работает → Версионирование промптов работает

## Следующие шаги

После успешного прохождения всех тестов:

1. Проверить метрики в базе данных
2. Проверить созданные улучшенные версии промптов
3. Проанализировать производительность через логи
4. Оптимизировать на основе результатов

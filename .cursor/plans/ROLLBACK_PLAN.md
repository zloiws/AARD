# План отката к состоянию до появления UI

## Анализ истории коммитов

### Первый коммит с frontend-next и ui
- **Коммит:** `3cd069e`
- **Сообщение:** "Рефакторинг UncertaintyService для саморазвития: вынесение всех параметров в БД"
- **Дата:** Wed Dec 10 19:31:20 2025 +0200
- **Изменения:** 
  - Добавлены папки `frontend-next/` и `ui/` (Next.js фронтенд)
  - Рефакторинг UncertaintyService
  - Создана модель UncertaintyParameter
  - И другие изменения

### Коммит для отката
- **Коммит:** `3264636` (коммит перед `3cd069e`)
- **Сообщение:** "feat(phase8): завершение фазы 8 - диалог между агентами"
- **Дата:** Sat Dec 6 00:31:46 2025 +0200
- Это последний коммит БЕЗ frontend-next/ui-изменений
- **Примечание:** После `3cd069e` было сделано только 16 коммитов до текущего HEAD

## Варианты отката

### Вариант 1: Мягкий откат (рекомендуется)
**Действия:**
1. Создать резервную ветку текущего состояния
2. Создать новую ветку от коммита `3264636` (до frontend-next/ui)
3. Переместить папку `ui_old` в безопасное место (уже сделано)
4. Сохранить все миграции БД, но реорганизовать их в единую миграцию

**Команды:**
```bash
# Создать резервную копию текущего состояния
git branch backup-with-ui

# Создать ветку для отката от коммита до frontend-next/ui
git checkout -b rollback-before-ui 3264636

# Или если нужно откатить текущую ветку main:
git checkout main
git reset --hard 3264636
```

### Вариант 2: Жесткий откат
**Действия:**
1. Полный откат к коммиту `3264636`
2. Удаление всех UI-связанных файлов
3. Реорганизация миграций БД

**Команды:**
```bash
# Создать резервную копию
git branch backup-with-ui

# Откат к коммиту до frontend-next/ui
git reset --hard 3264636

# Удаление UI-папок (если остались)
git clean -fd frontend/ ui_old/ frontend-next/ ui/
```

### Вариант 3: Селективный откат (самый безопасный)
**Действия:**
1. Создать новую ветку от `3264636`
2. Вручную удалить только UI-связанные файлы и изменения
3. Сохранить все остальные изменения (миграции, бэкенд-логику)

**Команды:**
```bash
# Создать резервную копию
git branch backup-with-ui

# Создать ветку от коммита до frontend-next/ui
git checkout -b clean-before-ui 3264636

# Вернуться на main
git checkout main

# Удалить только UI-файлы (если они есть в индексе)
git rm -r frontend/ ui_old/ frontend-next/ ui/ 2>$null
git commit -m "chore: remove UI directories before reorganization"
```

## Реорганизация миграций БД

После отката нужно:
1. Объединить все миграции в единую начальную миграцию
2. Убедиться, что все таблицы создаются идемпотентно
3. Создать скрипт для полной инициализации БД

### План реорганизации:
1. Создать новую миграцию `001_initial_schema.py`
2. Включить все необходимые таблицы:
   - `ollama_servers`
   - `ollama_models`
   - `agents`
   - `tools`
   - `tasks`
   - `plans`
   - `workflow_events`
   - `execution_graphs`, `execution_nodes`, `execution_edges`
   - `system_parameters`
   - `uncertainty_parameters`
   - И все остальные необходимые таблицы
3. Удалить старые миграции (или оставить как архив)
4. Создать скрипт `backend/scripts/init_db.py` для полной инициализации

## Сохраненные планы

Планы сохранены в:
- `.cursor/plans/SAVED_PLANS_BACKUP.md`
- Оригиналы:
  - `c:\Users\tehno\.cursor\plans\визуализация_самоэволюционирующей_системы_5e4c839b.plan.md`
  - `.cursor/plans/ToDo_1.md`

## Рекомендация

**Рекомендуется Вариант 1 (Мягкий откат)** - создание новой ветки от коммита `3264636` (до frontend-next/ui), что позволит:
- Сохранить текущее состояние в отдельной ветке `backup-with-ui`
- Начать чистую работу с реорганизацией БД
- При необходимости вернуться к UI-изменениям (всего 16 коммитов назад)
- Откат к состоянию после завершения фазы 8 (диалог между агентами)
## Финальный статус (автоматические действия выполнены)

✅ **ОТКАТ ВЫПОЛНЕН** (дата: 2025-12-11)

Выполненные шаги:
1. Создана резервная ветка `backup-with-ui` с текущим состоянием (коммит `966e218`).
2. Создана ветка `rollback-before-ui` от коммита `3264636`.
3. Добавлена единая идемпотентная SQL-схема `backend/sql/full_initial_schema.sql` и применена к БД.
4. Добавлены вспомогательные скрипты для применения патчей:
   - `backend/scripts/apply_full_schema.py`
   - `backend/scripts/apply_sql_init.py`
   - `backend/scripts/apply_sql_patch_agents.py`
   - `backend/scripts/apply_sql_patch_tasks.py`
   - `backend/scripts/apply_patch_tasks_id_to_uuid.py`
   - `backend/scripts/apply_sql_patch_round2.py`
   - `backend/scripts/apply_sql_patch_round2.py` (используется для дополнительных правок)
5. Таблицы для Ollama созданы и заполнены из `.env` (скрипт `create_ollama_sql_direct.py` / `create_ollama_tables_and_insert.py`), модели помечены активными.
6. Бэкенд запущен (uvicorn в venv), сервис отвечает, интеграционные тесты запущены автоматически.

Текущий результат тестов:
- Интеграционные тесты запускаются, но в ходе прогона выявляются отсутствия колонок/таблиц, которые автоматически патчатся (несколько раундов патчей применено). Сейчас наблюдаются оставшиеся ошибки по `workflow_events` и связанным таблицам; процесс можно продолжать автоматически до полного прохождения тестов.

Рекомендации и следующие шаги:
- Если вы подтверждаете, я продолжу автоматическое патчение схемы (буду добавлять недостающие колонки/таблицы и перезапускать тесты до зелёного состояния). Это займёт итеративный цикл — рекомендую позволить автомату действовать до финиша.
- Альтернатива: остановиться и собрать список оставшихся ошибок/отчёт для ручного анализа.

Сделано: все сохранения планов, резервные ветки и базовые SQL-правки применены.

## Статус выполнения

✅ **ОТКАТ ВЫПОЛНЕН** (дата: 2025-12-11)

**Выполненные действия:**
1. ✅ Создана резервная ветка `backup-with-ui` с текущим состоянием (коммит `966e218`)
2. ✅ Создана новая ветка `rollback-before-ui` от коммита `3264636`
3. ✅ Незакоммиченные изменения сохранены в stash
4. ✅ Проверено: UI директории (`frontend-next`, `ui`) отсутствуют на новой ветке
5. ✅ Текущая ветка: `rollback-before-ui`
6. ✅ Текущий коммит: `3264636` - "feat(phase8): завершение фазы 8 - диалог между агентами"

**Следующие шаги:**
- [ ] Реорганизовать миграции БД в единую идемпотентную миграцию
- [ ] Проверить работоспособность бэкенда на откатанной версии
- [ ] При необходимости восстановить изменения из stash


<!-- План: Управление ToDo-Списком и Workflow Engine для AARD -->
# План: Управление ToDo-Списком и Workflow Engine для AARD

## Статус реализации предыдущих этапов

### ✅ Этап 1: Dual-Model Architecture - ЗАВЕРШЕН
- ✅ 1.1. ModelSelector - реализован и протестирован
- ✅ 1.2. Function Calling Protocol - реализован и протестирован
- ✅ 1.3. Обновление PlanningService - интегрировано

### ✅ Этап 2: Human-in-the-Loop - ЗАВЕРШЕН
- ✅ 2.1. AdaptiveApprovalService - реализован и протестирован
- ✅ 2.2. InteractiveExecutionService - реализован и протестирован

### ✅ Этап 3: Meta-Learning - ЗАВЕРШЕН
- ✅ 3.1. MetaLearningService - реализован
- ✅ 3.2. FeedbackLearningService - реализован и протестирован
- ✅ 3.3. PlanningMetricsService - реализован и протестирован

### ✅ Этап 4: Безопасность - ЗАВЕРШЕН
- ✅ 4.1. CodeExecutionSandbox - реализован и протестирован

---

## Этап 6: Управление ToDo-Списком как Workflow Engine

### 6.1. Расширение жизненного цикла задач

**Файлы:**
- `backend/app/models/task.py` - обновить TaskStatus
- `backend/alembic/versions/017_extend_task_lifecycle.py` - новая миграция

**Задачи:**

1. Расширить `TaskStatus` enum:
   - Добавить: `DRAFT`, `PENDING_APPROVAL`, `ON_HOLD`, `CANCELLED`
   - Сохранить существующие: `PENDING`, `PLANNING`, `WAITING_APPROVAL`, `EXECUTING`, `PAUSED`, `COMPLETED`, `FAILED`

2. Добавить поля в Task:
   - `created_by_role` (planner, human, system)
   - `approved_by_role` (human, validator)
   - `autonomy_level` (0-4 для graduated autonomy)

3. Создать миграцию БД

**Приоритет:** Высокий (критично)

**Тестирование:**
- Обновить тесты для новых статусов
- Проверить переходы между статусами

**Очистка:**
- Удалить временные файлы

**Документация:**
- Создать `docs/guides/TASK_LIFECYCLE.md`

**Коммит:** `feat: Extend task lifecycle with workflow states`

---

### 6.2. Автоматический переход DRAFT → PENDING_APPROVAL

**Файлы:**
- `backend/app/services/planning_service.py` - обновить логику
- `backend/app/services/adaptive_approval_service.py` - расширить

**Задачи:**

1. Автоматически определять критические шаги:
   - Создание новых агентов/инструментов
   - Изменение существующих артефактов
   - Доступ к защищенным данным/API

2. Автоматически создавать ApprovalRequest для критических планов

3. Интегрировать с AdaptiveApprovalService для определения необходимости утверждения

**Приоритет:** Высокий (критично)

**Тестирование:**
- Тесты для автоматического определения критических шагов
- Тесты для автоматического создания approval requests

**Очистка:**
- Удалить временные файлы

**Документация:**
- Обновить `docs/guides/ADAPTIVE_APPROVAL.md`

**Коммит:** `feat: Auto-transition DRAFT to PENDING_APPROVAL for critical steps`

---

### 6.3. Автоматическое перепланирование при FAILED

**Файлы:**
- `backend/app/services/execution_service.py` - добавить триггер
- `backend/app/services/planning_service.py` - улучшить replan()
- `backend/app/services/reflection_service.py` - интеграция

**Задачи:**

1. При статусе FAILED:
   - Анализ ошибки через ReflectionService
   - Автоматический вызов replan() с контекстом ошибки
   - Создание нового плана с корректировками
   - Автоматический переход в PENDING_APPROVAL (если есть критические шаги)

2. Интеграция с MemoryService:
   - Сохранение паттернов ошибок
   - Применение изученных решений

**Приоритет:** Высокий (критично)

**Тестирование:**
- Тесты для автоматического replan при FAILED
- Тесты для интеграции с ReflectionService

**Очистка:**
- Удалить временные файлы

**Документация:**
- Создать `docs/guides/AUTOMATIC_REPLANNING.md`

**Коммит:** `feat: Automatic replanning on task failure with error analysis`

---

### 6.4. Интеграция с системой памяти

**Файлы:**
- `backend/app/services/memory_service.py` - расширить
- `backend/app/services/planning_service.py` - интеграция
- `backend/app/models/memory.py` - возможно расширение

**Задачи:**

1. Working Memory:
   - Сохранять активный ToDo-список в рабочей памяти
   - Связывать с текущей задачей

2. Episodic Memory:
   - История всех изменений планов
   - Сохранение контекста при каждом изменении
   - Извлечение паттернов: "В прошлый раз при 403 помог User-Agent"

3. Procedural Memory:
   - Шаблоны успешных планов (интеграция с MetaLearningService)
   - Применение шаблонов при планировании похожих задач

**Приоритет:** Средний

**Тестирование:**
- Тесты для сохранения истории планов
- Тесты для извлечения шаблонов

**Очистка:**
- Удалить временные файлы

**Документация:**
- Обновить `docs/guides/MEMORY.md`
- Создать `docs/guides/PLAN_MEMORY_INTEGRATION.md`

**Коммит:** `feat: Integrate plan lifecycle with memory system`

---

### 6.5. Единый Dashboard для управления задачами

**Файлы:**
- `frontend/templates/dashboard.html` - новый файл
- `backend/app/api/routes/dashboard.py` - новый файл
- `backend/app/api/routes/dashboard_pages.py` - новый файл

**Задачи:**

1. Создать Dashboard страницу:
   - Активные задачи (IN_PROGRESS, PENDING_APPROVAL)
   - Статус каждой задачи (визуальные индикаторы)
   - История изменений плана
   - Кнопки Approve/Reject для PENDING_APPROVAL
   - Возможность вручную добавить задачу
   - Возможность отменить выполнение

2. Real-time обновления (HTMX polling или WebSocket)

3. Интеграция с InteractiveExecutionService для паузы/возобновления

**Приоритет:** Средний

**Тестирование:**
- Проверка UI функциональности
- Тесты API endpoints

**Очистка:**
- Удалить временные файлы

**Документация:**
- Создать `docs/guides/DASHBOARD.md`

**Коммит:** `feat: Add unified dashboard for task management`

---

## Этап 7: Дополнительные рекомендации

### 7.1. Validate-Then-Build для агентов (Agent Approval Agent)

**Файлы:**
- `backend/app/services/agent_approval_service.py` - новый файл
- `backend/app/api/routes/agent_approval.py` - новый файл

**Задачи:**

1. Создать AgentApprovalService:
   - Проверка необходимости нового агента (против Agent Registry)
   - Формальное определение контракта (вход/выход, предусловия, постусловия)
   - Оценка ценности (ожидаемая выгода)
   - Анализ рисков (коллизии, ресурсы, безопасность)

2. Интеграция с ApprovalService:
   - Автоматическое создание approval request для новых агентов
   - Промпт для человека с анализом

**Приоритет:** Средний

**Тестирование:**
- Тесты для проверки необходимости агента
- Тесты для оценки ценности и рисков

**Очистка:**
- Удалить временные файлы

**Документация:**
- Создать `docs/guides/AGENT_APPROVAL.md`

**Коммит:** `feat: Add Validate-Then-Build pattern for agent creation`

---

### 7.2. Digital Twin of the Task

**Файлы:**
- `backend/app/models/task_instance.py` - новая модель
- `backend/alembic/versions/018_add_task_instances.py` - миграция
- `backend/app/services/task_instance_service.py` - новый сервис

**Задачи:**

1. Создать модель TaskInstance:
   - JSONB поле `context` для полного контекста задачи
   - Объединение: исходный запрос, планы, артефакты, логи, история

2. Создать TaskInstanceService:
   - Централизованное чтение/запись контекста
   - Воспроизводимость состояния на любой этап

3. Интеграция:
   - Planner, Coder, Validator читают/пишут в TaskInstance
   - Полная наблюдаемость

**Приоритет:** Средний

**Тестирование:**
- Тесты для сохранения/восстановления контекста
- Тесты для воспроизводимости

**Очистка:**
- Удалить временные файлы

**Документация:**
- Создать `docs/guides/TASK_INSTANCE.md`

**Коммит:** `feat: Add Digital Twin concept for tasks`

---

### 7.3. Plan Voting / A/B Testing Plans

**Файлы:**
- `backend/app/services/plan_voting_service.py` - новый файл
- `backend/app/services/planning_service.py` - расширить

**Задачи:**

1. Создать PlanVotingService:
   - Генерация нескольких альтернативных планов (2-3 варианта)
   - Сравнение планов по критериям:
     - Ожидаемое время выполнения
     - Количество точек утверждения
     - Уровень риска
     - Эффективность (минимальные шаги)

2. Интеграция с PlanningService:
   - Опциональная генерация нескольких планов
   - Выбор лучшего плана

3. UI для выбора плана:
   - Отображение нескольких вариантов
   - Сравнительная таблица
   - Выбор пользователем

**Приоритет:** Низкий

**Тестирование:**
- Тесты для генерации альтернативных планов
- Тесты для сравнения планов

**Очистка:**
- Удалить временные файлы

**Документация:**
- Создать `docs/guides/PLAN_VOTING.md`

**Коммит:** `feat: Add Plan Voting / A/B Testing for plans`

---

### 7.4. Версионность артефактов (расширение)

**Файлы:**
- `backend/app/models/prompt.py` - добавить версионирование
- `backend/app/models/tool.py` - добавить версионирование
- `backend/app/services/artifact_versioning_service.py` - новый файл

**Задачи:**

1. Версионирование промптов:
   - Поле `version_id` в Prompt
   - Changelog для изменений
   - Откат к предыдущей версии

2. Версионирование инструментов:
   - Аналогично промптам

3. Валидация версий:
   - Проверка, что новая версия не ухудшает метрики

**Приоритет:** Средний

**Тестирование:**
- Тесты для версионирования
- Тесты для отката

**Очистка:**
- Удалить временные файлы

**Документация:**
- Обновить `docs/guides/ARTIFACTS.md`

**Коммит:** `feat: Extend artifact versioning to prompts and tools`

---

### 7.5. Self-Audit Loop

**Файлы:**
- `backend/app/services/self_audit_service.py` - новый файл
- `backend/app/services/agent_gym_service.py` - интеграция

**Задачи:**

1. Создать SelfAuditService:
   - Регулярный выбор случайных завершенных задач
   - Повторное выполнение с текущими версиями моделей/промптов
   - Сравнение результатов (время, утверждения, качество)
   - Генерация отчета "Улучшение производительности"

2. Планировщик задач:
   - Запуск раз в день/неделю
   - Использование Agent Gym для выполнения

**Приоритет:** Низкий

**Тестирование:**
- Тесты для повторного выполнения
- Тесты для сравнения результатов

**Очистка:**
- Удалить временные файлы

**Документация:**
- Создать `docs/guides/SELF_AUDIT.md`

**Коммит:** `feat: Add Self-Audit Loop for performance tracking`

---

### 7.6. Расширенная изоляция выполнения

**Файлы:**
- `backend/app/services/code_execution_sandbox.py` - расширить
- `backend/app/services/network_proxy_service.py` - новый файл
- `backend/app/services/rbac_service.py` - новый файл

**Задачи:**

1. Docker-based sandbox:
   - Интеграция с Docker для изоляции
   - Ограничения ресурсов через Docker

2. Network Proxy:
   - Прокси для HTTP-запросов
   - Логирование, ограничение частоты
   - Блокировка опасных доменов

3. RBAC для агентов:
   - Роли агентов (read-only, read-write, admin)
   - Проверка прав перед выполнением

**Приоритет:** Средний

**Тестирование:**
- Тесты для Docker sandbox
- Тесты для network proxy
- Тесты для RBAC

**Очистка:**
- Удалить временные файлы

**Документация:**
- Обновить `docs/guides/CODE_EXECUTION_SAFETY.md`

**Коммит:** `feat: Enhance execution isolation with Docker and network proxy`

---

### 7.7. Graduated Autonomy (Градуированная автономия)

**Файлы:**
- `backend/app/models/task.py` - добавить поле autonomy_level
- `backend/app/services/autonomy_service.py` - новый файл
- `backend/app/services/approval_service.py` - интеграция

**Задачи:**

1. Добавить уровни автономии:
   - Уровень 0: Только чтение (анализ и предложение)
   - Уровень 1: Подтверждение каждого шага
   - Уровень 2: Утверждение плана
   - Уровень 3: Автономия с уведомлением
   - Уровень 4: Полный автомат

2. Создать AutonomyService:
   - Проверка уровня перед остановкой
   - Автоматическое пропускание утверждений на высоких уровнях

3. UI для настройки уровня:
   - Выбор уровня при создании задачи
   - Изменение уровня во время выполнения

**Приоритет:** Средний

**Тестирование:**
- Тесты для проверки уровней
- Тесты для автоматического пропуска утверждений

**Очистка:**
- Удалить временные файлы

**Документация:**
- Создать `docs/guides/GRADUATED_AUTONOMY.md`

**Коммит:** `feat: Add Graduated Autonomy levels for tasks`

---

## Порядок реализации (по критичности)

### Фаза 1: Критические улучшения жизненного цикла (1-2 недели)

1. **6.1** - Расширение жизненного цикла задач (2-3 дня) ⚠️ В ПРОЦЕССЕ
2. **6.2** - Автоматический переход DRAFT → PENDING_APPROVAL (2 дня)
3. **6.3** - Автоматическое перепланирование при FAILED (3-4 дня)
4. **UI: Добавить ссылку на метрики** (30 минут)

### Фаза 2: Интеграция и улучшения (1-2 недели)

5. **6.4** - Интеграция с системой памяти (3-4 дня)
6. **6.5** - Единый Dashboard (3-4 дня)
7. **7.7** - Graduated Autonomy (2-3 дня)

### Фаза 3: Дополнительные функции (2-3 недели)

8. **7.1** - Validate-Then-Build для агентов (3-4 дня)
9. **7.2** - Digital Twin of the Task (4-5 дней)
10. **7.4** - Расширенная версионность артефактов (2-3 дня)
11. **7.6** - Расширенная изоляция выполнения (3-4 дня)

### Фаза 4: Продвинутые функции (опционально)

12. **7.3** - Plan Voting / A/B Testing (3-4 дня)
13. **7.5** - Self-Audit Loop (3-4 дня)

**Общее время: 4-6 недель для критических функций, 8-12 недель для всех**

---

## Стандартная процедура завершения этапа

**Перед переходом к следующему этапу (обязательно):**

1. **Тестирование** - все тесты должны пройти
2. **Очистка** - удалить временные файлы из корня
3. **Документация** - создать/обновить документацию
4. **Коммит** - закоммитить с понятным сообщением

**Это правило применяется ко ВСЕМ этапам без исключения.**

---

## Зависимости

- 6.1 → 6.2 (нужны новые статусы для автоматических переходов)
- 6.2 → 6.3 (нужна автоматизация для replan)
- 6.4 зависит от MemoryService (уже реализован)
- 6.5 зависит от 6.1-6.3 (нужен полный lifecycle)
- 7.1 зависит от Agent Registry (уже есть)
- 7.2 независим, но интегрируется со всеми сервисами
- 7.7 зависит от ApprovalService (уже реализован)

---

## Приоритеты

**Критично (реализовать первыми):**
- 6.1, 6.2, 6.3 - основа workflow engine
- Добавить ссылку на метрики в UI

**Важно:**
- 6.4, 6.5 - интеграция и UX
- 7.7 - гибкость системы

**Желательно:**
- 7.1, 7.2, 7.4, 7.6 - дополнительные функции

**Опционально:**
- 7.3, 7.5 - продвинутые функции


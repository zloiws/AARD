<!-- 6d8dd0f8-6800-4f1f-98ce-2702569f3c9f 2f752476-46d1-470c-94e4-485fa3a74613 -->
# План доработки AARD: UI, безопасность и продвинутые функции

## Этап 1: Веб-интерфейс для Agent Gym

### 1.1. Страницы для тестов

**Файлы:**

- `frontend/templates/agent_gym/` - новые шаблоны
- `backend/app/api/routes/agent_gym_pages.py` - страницы

**Задачи:**

1. Создать страницу списка тестов (`list.html`):

- Таблица с тестами (название, тип, статус, последний запуск)
- Фильтры по типу, статусу
- Кнопки: создать, запустить, просмотреть результаты

2. Создать страницу создания/редактирования теста (`create.html`, `edit.html`):

- Форма с полями: название, описание, тип, входные данные, ожидаемый результат
- Предпросмотр теста
- Сохранение и валидация

3. Создать страницу результатов теста (`results.html`):

- Детали выполнения теста
- Сравнение результатов разных запусков
- Графики производительности

### 1.2. Страницы для бенчмарков

**Задачи:**

1. Создать страницу списка бенчмарков (`benchmarks_list.html`)
2. Создать страницу создания бенчмарка (`benchmark_create.html`)
3. Создать страницу результатов бенчмарка (`benchmark_results.html`):

- Сравнение агентов
- Визуализация метрик
- Экспорт результатов

### 1.3. Интеграция в главное меню

**Файл:** `frontend/templates/main.html`

**Задачи:**

1. Добавить вкладку "Agent Gym" в навигацию
2. Встроить страницы в iframe (как для агентов и инструментов)

## Этап 2: Система аутентификации и авторизации

### 2.1. Модели и миграция

**Файлы:**

- `backend/app/models/user.py` - модель пользователя
- `backend/app/models/session.py` - модель сессии
- `backend/alembic/versions/015_add_authentication.py` - миграция

**Задачи:**

1. Создать модель `User`:

- `id`, `username`, `email`, `password_hash`
- `role` (admin, user, viewer)
- `created_at`, `last_login`, `is_active`

2. Создать модель `Session`:

- `id`, `user_id`, `token`, `expires_at`
- `created_at`, `last_activity`

3. Создать миграцию БД

### 2.2. Сервис аутентификации

**Файл:** `backend/app/services/auth_service.py`

**Задачи:**

1. Реализовать `AuthService`:

- `register_user()` - регистрация
- `authenticate()` - аутентификация (проверка пароля)
- `create_session()` - создание сессии
- `validate_session()` - проверка сессии
- `logout()` - выход

2. Хеширование паролей (bcrypt)
3. Генерация токенов (JWT или случайные токены)

### 2.3. Middleware и декораторы

**Файлы:**

- `backend/app/core/auth.py` - middleware и декораторы
- `backend/app/core/permissions.py` - проверка прав доступа

**Задачи:**

1. Создать middleware для проверки аутентификации
2. Создать декораторы:

- `@require_auth` - требует аутентификации
- `@require_role(role)` - требует определенной роли
- `@require_permission(permission)` - требует права

### 2.4. API endpoints

**Файл:** `backend/app/api/routes/auth.py`

**Задачи:**

1. Endpoints:

- `POST /api/auth/register` - регистрация
- `POST /api/auth/login` - вход
- `POST /api/auth/logout` - выход
- `GET /api/auth/me` - текущий пользователь
- `POST /api/auth/refresh` - обновление токена

### 2.5. Веб-интерфейс аутентификации

**Файлы:**

- `frontend/templates/auth/login.html` - страница входа
- `frontend/templates/auth/register.html` - страница регистрации

**Задачи:**

1. Создать страницу входа
2. Создать страницу регистрации
3. Интегрировать проверку сессии в базовый шаблон

### 2.6. Замена hardcoded "user"

**Задачи:**

1. Найти все места с hardcoded "user"
2. Заменить на получение из сессии
3. Обновить все API endpoints

## Этап 3: RAG-система на pgvector

### 3.1. Установка и настройка pgvector

**Задачи:**

1. Проверить наличие расширения pgvector в БД
2. Создать миграцию для включения расширения (если нужно)
3. Настроить индексы для векторного поиска

### 3.2. Генерация embeddings

**Файл:** `backend/app/services/embedding_service.py`

**Задачи:**

1. Реализовать `EmbeddingService`:

- `generate_embedding(text)` - генерация embedding
- `generate_embeddings_batch(texts)` - batch генерация
- Интеграция с Ollama для генерации embeddings

2. Кэширование embeddings

### 3.3. Обновление моделей памяти

**Файл:** `backend/app/models/agent_memory.py`

**Задачи:**

1. Добавить поле `embedding` в `AgentMemory` (vector(768))
2. Создать миграцию для добавления поля
3. Обновить индексы для векторного поиска

### 3.4. Семантический поиск

**Файл:** `backend/app/services/memory_service.py`

**Задачи:**

1. Добавить метод `semantic_search()`:

- Генерация embedding для запроса
- Векторный поиск в БД (cosine similarity)
- Ранжирование результатов

2. Интегрировать в существующий `search_memories()`

### 3.5. Автоматическая индексация

**Задачи:**

1. Автоматическая генерация embeddings при создании памяти
2. Индексация артефактов при создании
3. Фоновая задача для индексации существующих данных

## Этап 4: LM Judge система

### 4.1. Модель оценки

**Файл:** `backend/app/models/judge_result.py`

**Задачи:**

1. Создать модель `JudgeResult`:

- `task_id`, `agent_id`, `result_id`
- Оценки по аспектам (корректность, полнота, безопасность, стиль, эффективность)
- Общая оценка, комментарий

### 4.2. Сервис оценки

**Файл:** `backend/app/services/judge_service.py`

**Задачи:**

1. Реализовать `JudgeService`:

- `evaluate_result()` - оценка результата
- `evaluate_aspect()` - оценка отдельного аспекта
- Использование отдельной LLM модели для оценки

2. Промпты для оценки каждого аспекта
3. Парсинг ответов LLM в структурированные оценки

### 4.3. Интеграция с CriticService

**Файл:** `backend/app/services/critic_service.py`

**Задачи:**

1. Интегрировать `JudgeService` в `CriticService`
2. Использовать LM Judge для качественной оценки
3. Комбинировать с код-валидацией

### 4.4. API и метрики

**Задачи:**

1. API endpoint для запуска оценки
2. Сохранение результатов оценки
3. Метрики и статистика по оценкам

## Этап 5: Дополнительные улучшения

### 5.1. Визуализация планов

**Файлы:**

- `frontend/templates/plans/visualization.html`
- `backend/app/api/routes/plans_pages.py`

**Задачи:**

1. Визуализация дерева задач
2. Gantt диаграмма выполнения
3. Граф зависимостей шагов

### 5.2. Dashboard с метриками

**Файлы:**

- `frontend/templates/dashboard/index.html`
- `backend/app/api/routes/metrics.py`

**Задачи:**

1. Dashboard с метриками агентов
2. Графики производительности
3. Статистика по тестам и бенчмаркам

### 5.3. A/B тестирование промптов

**Задачи:**

1. Расширить систему экспериментов для промптов
2. Создание вариантов промптов
3. Сравнение эффективности

### 5.4. Мониторинг деградации агентов

**Задачи:**

1. Система отслеживания метрик производительности
2. Обнаружение снижения эффективности
3. Автоматические алерты и рекомендации

## Порядок реализации

1. **Этап 1**: Веб-интерфейс для Agent Gym (2-3 дня)
2. **Этап 2**: Система аутентификации (3-4 дня)
3. **Этап 3**: RAG-система на pgvector (4-5 дней)
4. **Этап 4**: LM Judge система (3-4 дня)
5. **Этап 5**: Дополнительные улучшения (по приоритетам)

**Общее время: 12-16 дней**

## Зависимости

- Agent Gym UI не зависит от других компонентов
- Аутентификация нужна для всех защищенных endpoints
- RAG-система расширяет существующую память
- LM Judge интегрируется с CriticService

### To-dos

- [ ] Реализовать A2A взаимодействие (Agent-to-Agent communication): протокол общения, Agent Registry, маршрутизация сообщений
- [ ] Реализовать heartbeat механизм для агентов: периодическая проверка доступности, автоматическое обнаружение недоступных агентов
- [ ] Реализовать версионирование агентов: создание новых версий, откат к предыдущим версиям
- [ ] Реализовать A/B тестирование агентов: сравнение производительности разных версий
- [ ] Реализовать Agent Gym для тестирования агентов: автоматические тесты, бенчмарки
- [ ] Создать веб-интерфейс для управления инструментами: список, создание, редактирование, назначение агентам
- [ ] Применить миграцию 011_add_agent_heartbeat для добавления полей heartbeat в таблицу agents
- [ ] Исправить ошибку UUID в traces_pages.py - добавить преобразование строки в UUID
- [ ] Добавить фильтрацию SQLAlchemy spans - не сохранять автоматические запросы без полезных данных
- [ ] Протестировать исправления трассировок
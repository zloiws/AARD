# Рефакторинг хардкодных параметров для саморазвития системы

## Проблема

В основном коде было обнаружено множество хардкодных параметров (пороги, веса, списки ключевых слов), которые препятствовали саморазвитию системы. Эти параметры не могли адаптироваться на основе опыта работы системы.

## Причины рефакторинга

1. **Саморазвитие невозможно**: Хардкодные значения не позволяют системе учиться на ошибках и улучшать свои решения
2. **Отсутствие гибкости**: Невозможно настроить параметры без изменения кода
3. **Нет отслеживания**: Нет истории изменений параметров и метрик их эффективности
4. **Нет A/B тестирования**: Невозможно сравнивать разные наборы параметров

## Выполнено

### 1. UncertaintyService ✅
**Файлы:**
- `backend/app/models/uncertainty_parameters.py` - модель для хранения параметров
- `backend/app/services/uncertainty_learning_service.py` - сервис обучения
- `backend/app/services/uncertainty_service.py` - рефакторинг основного сервиса
- `backend/app/models/uncertainty_types.py` - вынесены enum'ы

**Что вынесено:**
- Все веса типов неопределенности (0.2, 0.15, 0.25, 0.3, 0.1)
- Все пороги уровней (0.7, 0.5, 0.3, 0.1)
- Все списки ключевых слов (vague_verbs, question_words, reference_words, etc.)
- Все пороги проверок (min_query_length, max_capitalized_words, etc.)

**Механизм обучения:**
- Обучение на основе обратной связи (correct, over_escalated, under_escalated, missed)
- Адаптация весов и порогов на основе результатов
- Обновление ключевых слов через LLM на основе исторических данных

### 2. AdaptiveApprovalService ✅
**Файлы:**
- `backend/app/models/system_parameter.py` - общая модель для всех сервисов
- `backend/app/services/parameter_manager.py` - централизованный менеджер параметров
- `backend/app/services/adaptive_approval_service.py` - рефакторинг

**Что вынесено:**
- Пороги: `TRUST_SCORE_THRESHOLD = 0.8`, `HIGH_RISK_THRESHOLD = 0.7`, `MEDIUM_RISK_THRESHOLD = 0.4`
- Минимум выполнений: `MIN_EXECUTIONS_FOR_TRUST = 5`
- Веса для trust score: `0.6` (success_rate), `0.2` (experience), `0.2` (recent_performance)
- Пороги для расчета риска: `0.3, 0.2, 0.1` (steps), `0.4, 0.3, 0.2` (operations), `0.2, 0.1, 0.1, 0.05` (dependencies)
- Порог для автономии уровня 4: `0.9`

**Параметры в БД:**
- `high_risk_threshold` (default: 0.7)
- `medium_risk_threshold` (default: 0.4)
- `trust_score_threshold` (default: 0.8)
- `low_trust_threshold` (default: 0.5)
- `min_executions_for_trust` (default: 5)
- `weight_trust_success_rate` (default: 0.6)
- `weight_trust_experience` (default: 0.2)
- `weight_trust_recent_performance` (default: 0.2)
- `risk_steps_high/medium/low` (defaults: 0.3, 0.2, 0.1)
- `risk_ops_high/medium/low` (defaults: 0.4, 0.3, 0.2)
- И другие параметры расчета риска

## В процессе / Планируется

### 3. CriticService ⏳
**Что нужно вынести:**
- Пороги валидации: `0.6` (overall_score), `0.7` (quality_threshold, validation_score)
- Штрафы за ошибки: `-0.2, -0.1, -0.5, -0.3, -0.2, -0.1`
- Пороги для семантической валидации: `0.3` (overlap threshold), `10` (min result length)

**Приоритет:** Высокий (влияет на валидацию всех результатов)

### 4. ConflictResolutionService ⏳
**Что нужно вынести:**
- Пороги: `similarity > 0.7`, `priority_diff >= 3`, `len(active_tasks) < 2`
- Списки ключевых слов для противоречий
- Списки ключевых слов для типов ресурсов

**Приоритет:** Средний (влияет на разрешение конфликтов)

### 5. QuotaManagementService ⏳
**Что нужно вынести:**
- Пороги предупреждений: `0.8` (warning_threshold), `0.95` (critical threshold)
- Списки ключевых слов для определения типов ресурсов
- Пороги для оценки ресурсов: `50, 20` (task description length)

**Приоритет:** Средний (влияет на управление ресурсами)

### 6. PlanningService ⏳
**Что нужно вынести:**
- Пороги: `min_success_rate=0.7`, `overall_risk > 0.7`, `overall_risk > 0.4`
- Веса для оценки планов: `0.25, 0.20, 0.25, 0.30` (execution_time, approval_points, risk_level, efficiency)
- Пороги важности: `0.7, 0.8` (importance thresholds)

**Приоритет:** Высокий (влияет на создание планов)

### 7. MemoryService ⏳
**Что нужно вынести:**
- Значения по умолчанию: `similarity_threshold=0.7`, `importance=0.5`, `strength=0.5`

**Приоритет:** Низкий (значения по умолчанию)

## Архитектура решения

### Модель SystemParameter
```python
- category: ParameterCategory (APPROVAL, CRITIC, PLANNING, etc.)
- parameter_type: SystemParameterType (WEIGHT, THRESHOLD, KEYWORD_LIST, etc.)
- numeric_value: для весов, порогов, штрафов
- json_value: для списков ключевых слов
- learning_history: история изменений
- performance_metrics: метрики производительности
- version: версионирование параметров
```

### ParameterManager
- Централизованное управление параметрами
- Ленивая загрузка с кэшированием
- Автоматическое создание параметров с дефолтными значениями
- Поддержка всех категорий сервисов

### Механизм обучения (для будущей реализации)
1. **Сбор обратной связи**: После выполнения задачи собирается информация о правильности решения
2. **Анализ результатов**: Определяется, был ли параметр слишком строгим/мягким
3. **Адаптация**: Параметры корректируются на основе результатов
4. **Версионирование**: Все изменения сохраняются в истории
5. **Метрики**: Отслеживается производительность параметров

## Преимущества

1. ✅ **Саморазвитие**: Система может адаптировать параметры на основе опыта
2. ✅ **Гибкость**: Легко настраивать параметры без изменения кода
3. ✅ **Отслеживаемость**: История всех изменений параметров
4. ✅ **Метрики**: Отслеживание производительности параметров
5. ✅ **A/B тестирование**: Возможность сравнивать разные наборы параметров
6. ✅ **LLM-улучшения**: Автоматическое обновление ключевых слов через LLM

## Следующие шаги

1. ⏳ Рефакторинг CriticService (приоритет 1)
2. ⏳ Рефакторинг PlanningService (приоритет 1)
3. ⏳ Рефакторинг ConflictResolutionService (приоритет 2)
4. ⏳ Рефакторинг QuotaManagementService (приоритет 2)
5. ⏳ Рефакторинг MemoryService (приоритет 3)
6. ⏳ Создание сервисов обучения для каждого компонента
7. ⏳ Интеграция обучения в основной workflow
8. ⏳ API endpoints для управления параметрами
9. ⏳ Визуализация истории изменений параметров

## Коммиты

- `3cd069e` - Рефакторинг UncertaintyService для саморазвития
- В процессе - Рефакторинг AdaptiveApprovalService


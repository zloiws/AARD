# Безопасность тестирования планирования

## Проблема

Тест создания плана через LLM может:
- Зациклиться и работать бесконечно
- Создать долгую нагрузку на GPU
- Заблокировать сервер

## Решение

### 1. Отключено автоматическое создание плана в тесте
- Тест теперь использует существующие планы из БД
- Создание плана через LLM отключено по умолчанию

### 2. Добавлены таймауты
- В `planning_service.py`: 5 минут максимум для каждого этапа (анализ, декомпозиция)
- В `OllamaClient`: 10 минут для задач планирования
- Используется `asyncio.wait_for()` для принудительного прерывания

### 3. Защита от зацикливания
- Явные таймауты на каждом этапе генерации плана
- Обработка `asyncio.TimeoutError` с понятными сообщениями
- Fallback на простые значения при ошибках

## Как безопасно тестировать

### Упрощенный тест (рекомендуется)
```bash
python test_planning_api_simple.py
```
- Не создает планы через LLM
- Работает с существующими планами
- Быстрый и безопасный

### Полный тест (только если нужно)
```bash
python test_planning_api.py
```
- ⚠️  Создание плана отключено по умолчанию
- Использует существующие планы
- Перепланирование отключено

### Ручное создание плана (с осторожностью)
```bash
curl -X POST http://localhost:8000/api/plans/ \
  -H "Content-Type: application/json" \
  -d '{"task_description": "Простая задача"}'
```
- ⚠️  Может занять 5-10 минут
- ⚠️  Может загрузить GPU
- ⚠️  Следите за временем выполнения

## Рекомендации

1. **Всегда используйте упрощенный тест** для базовой проверки
2. **Создавайте планы вручную** только при необходимости
3. **Мониторьте GPU** при создании планов
4. **Используйте простые задачи** для тестирования
5. **Проверяйте таймауты** - если запрос длится более 5 минут, что-то не так

## Технические детали

### Таймауты в коде
- `planning_service._analyze_task()`: 300 секунд (5 минут)
- `planning_service._decompose_task()`: 300 секунд (5 минут)
- `OllamaClient.generate()` для PLANNING: 600 секунд (10 минут)
- Тест: 600 секунд (10 минут)

### Защита от зацикливания
- `asyncio.wait_for()` принудительно прерывает долгие операции
- Обработка исключений с fallback значениями
- Логирование для отладки


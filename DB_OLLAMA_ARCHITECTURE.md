# Архитектура хранения Ollama серверов в БД

## Проблема

Сейчас конфигурация Ollama серверов хранится в `.env`, и даже при выборе другого сервера/модели система использует конфигурацию из .env.

## Решение

Хранить конфигурацию Ollama серверов и моделей в БД PostgreSQL. Это позволяет:
- Динамически добавлять/удалять серверы
- Хранить авторизацию для каждого сервера
- Отслеживать доступность серверов и моделей
- Управлять через API

## Структура БД

### Таблица `ollama_servers`
- `id` - UUID
- `name` - имя сервера
- `url` - базовый URL (http://10.39.0.6:11434)
- `api_version` - версия API (обычно "v1")
- `auth_type` - тип авторизации ("none", "basic", "bearer", "api_key")
- `auth_config` - JSON с параметрами авторизации
- `is_active` - активен ли сервер
- `is_default` - сервер по умолчанию
- `capabilities` - JSON массив возможностей
- `max_concurrent` - максимум одновременных запросов
- `priority` - приоритет
- `is_available` - доступность (обновляется при health check)
- `last_checked_at` - последняя проверка

### Таблица `ollama_models`
- `id` - UUID
- `server_id` - FK на ollama_servers
- `name` - отображаемое имя
- `model_name` - точное имя модели из Ollama API
- `size_bytes` - размер модели
- `digest` - хеш модели
- `is_active` - активна ли модель
- `capabilities` - JSON массив возможностей модели

## Логика работы

1. **При указанном server_url и model:**
   - Ищем сервер в БД по URL
   - Если найден - используем его и запрашиваемую модель
   - Если не найден - создаем динамический instance (без сохранения в БД)
   - **ВАЖНО:** Нет fallback на конфигурацию из .env

2. **При указанной только model:**
   - Ищем модель в БД по всем серверам
   - Используем найденный сервер

3. **Автовыбор:**
   - Используем сервер по умолчанию из БД
   - Если нет - первый активный сервер

## API для управления

- `GET /api/servers` - список серверов
- `POST /api/servers` - создать сервер
- `GET /api/servers/{id}` - получить сервер
- `PUT /api/servers/{id}` - обновить сервер
- `DELETE /api/servers/{id}` - удалить сервер
- `POST /api/servers/{id}/discover` - обнаружить модели на сервере
- `GET /api/servers/{id}/models` - список моделей сервера

## Миграция

Создана миграция `002_ollama_servers_models.py` для создания таблиц.

## Инициализация

При первом запуске можно создать серверы из .env через скрипт миграции данных.


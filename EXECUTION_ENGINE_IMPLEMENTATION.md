# Реализация движка выполнения планов

## Обзор

Реализован полнофункциональный движок выполнения планов (Execution Engine), который последовательно выполняет шаги плана, обрабатывает зависимости, ошибки и утверждения.

## Реализованные компоненты

### 1. ExecutionService
**Файл:** `backend/app/services/execution_service.py`

**Основные функции:**
- `execute_plan(plan_id)` - выполняет план шаг за шагом
- `get_execution_status(plan_id)` - возвращает текущий статус выполнения

**Особенности:**
- Последовательное выполнение шагов
- Проверка зависимостей между шагами
- Обновление прогресса в реальном времени
- Обработка ошибок и таймаутов
- Поддержка шагов, требующих утверждения

### 2. StepExecutor
**Класс:** `StepExecutor`

**Методы:**
- `execute_step()` - выполняет отдельный шаг плана
- `_execute_action_step()` - выполняет action шаги через LLM
- `_execute_decision_step()` - выполняет decision шаги (placeholder)
- `_execute_validation_step()` - выполняет validation шаги (placeholder)

**Особенности:**
- Автоматический выбор модели на основе capabilities
- Поддержка таймаутов для каждого шага
- Создание approval requests для шагов, требующих утверждения
- Обработка JSON ответов от LLM
- Сериализация контекста выполнения (с поддержкой datetime)

## Интеграция с API

### Обновленные endpoints

**POST `/api/plans/{plan_id}/execute`**
- Использует `ExecutionService.execute_plan()`
- Асинхронное выполнение плана
- Возвращает обновленный план

**GET `/api/plans/{plan_id}/status`**
- Использует `ExecutionService.get_execution_status()`
- Возвращает текущий статус, прогресс, время выполнения

## Типы шагов

### 1. Action (действие)
- Выполняется через LLM
- Использует модель с capability `code_generation` (если доступна)
- Таймаут: 300 секунд (по умолчанию)
- Результат: JSON с `status`, `output`, `metadata`

### 2. Decision (решение)
- Placeholder реализация
- В будущем: использование reasoning моделей

### 3. Validation (валидация)
- Placeholder реализация
- В будущем: проверка условий и критериев

### 4. Approval (утверждение)
- Автоматически создается approval request
- План приостанавливается до утверждения
- После утверждения выполнение продолжается

## Обработка ошибок

1. **Таймауты:** шаг помечается как `failed` при превышении таймаута
2. **Исключения:** логируются и сохраняются в результате шага
3. **Зависимости:** проверка наличия всех зависимостей перед выполнением
4. **Сериализация:** автоматическая конвертация datetime в ISO формат

## Тестирование

**Файл:** `backend/test_execution_engine.py`

**Результаты теста:**
- ✅ Создание плана
- ✅ Утверждение плана
- ✅ Выполнение всех шагов
- ✅ Обновление прогресса
- ✅ Обработка разных типов шагов
- ✅ Завершение плана со статусом `completed`

**Пример выполнения:**
```
✓ План создан: 9c1fff2e-a517-48c5-9246-0e606d2fbc8b
✓ План утвержден
✓ Статус: approved
✓ Шагов: 6
✓ Выполнение завершено
✓ Финальный статус: completed
✓ Прогресс: 100.0%
✓ Фактическое время: 0.2 минут
```

## Статусы выполнения

- `approved` - план утвержден, готов к выполнению
- `executing` - план выполняется
- `completed` - все шаги выполнены успешно
- `failed` - выполнение завершилось с ошибкой
- `waiting_approval` - ожидает утверждения шага

## Следующие шаги

1. **Интеграция с агентами** - использование реальных агентов вместо LLM
2. **Интеграция с инструментами** - выполнение шагов через инструменты
3. **WebSocket обновления** - обновления прогресса в реальном времени
4. **Перепланирование** - автоматическое перепланирование при ошибках
5. **Параллельное выполнение** - выполнение независимых шагов параллельно

## Измененные файлы

**Backend:**
- `backend/app/services/execution_service.py` - новый файл
- `backend/app/api/routes/plans.py` - обновлены endpoints

**Тесты:**
- `backend/test_execution_engine.py` - новый тестовый скрипт

**Документация:**
- `EXECUTION_ENGINE_IMPLEMENTATION.md` - этот файл

